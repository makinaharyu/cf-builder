<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カード詳細</title>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: sans-serif; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { display: flex; flex-wrap: wrap; max-width: 800px; width: 100%; gap: 20px; background: #161b22; padding: 20px; border-radius: 8px; border: 1px solid #30363d; box-sizing: border-box; }
        .card-image-box { flex: 0 0 auto; width: 100%; max-width: 300px; display: flex; justify-content: center; align-items: flex-start; }
        .card-image { width: 100%; height: auto; border-radius: 10px; border: 1px solid #30363d; }
        .card-info { flex: 1; min-width: 300px; }
        h1 { margin-top: 0; border-bottom: 1px solid #30363d; padding-bottom: 10px; color: #f1c40f; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #30363d; }
        th { color: #8b949e; width: 30%; font-weight: normal; }
        td { color: #fff; font-weight: bold; white-space: pre-wrap; }
        .back-btn { margin-top: 20px; display: inline-block; color: #58a6ff; text-decoration: none; border: 1px solid #30363d; padding: 10px 20px; border-radius: 6px; background: #21262d; }
        .back-btn:hover { background: #30363d; }
        .error { color: #ff7b72; font-weight: bold; }
    </style>
</head>
<body>
<div id="content" class="container"><p>読み込み中...</p></div>
<script>
    const CSV_PATH = 'card_list.csv'; 
    function getParam(name) { return new URLSearchParams(window.location.search).get(name); }
    
    // index.htmlと同じ、クォート対応のCSVパーサー
    function parseCSV(text) {
        const lines = text.split(/\r?\n/);
        const headers = lines[0].split(',').map(h => h.trim());
        const result = [];
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            // カンマ区切り（ダブルクォート内のカンマは無視）
            const cells = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if(cells.length < headers.length) continue;
            const obj = {};
            for (let j = 0; j < headers.length; j++) {
                let val = cells[j] ? cells[j].trim() : '';
                if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1).replace(/""/g, '"');
                obj[headers[j]] = val;
            }
            result.push(obj);
        }
        return result;
    }

    async function init() {
        const targetName = getParam('name');
        const contentDiv = document.getElementById('content');
        if (!targetName) {
            contentDiv.innerHTML = '<p class="error">カード名が指定されていません。</p><a href="javascript:window.close()" class="back-btn">閉じる</a>';
            return;
        }
        try {
            const response = await fetch(CSV_PATH);
            if (!response.ok) throw new Error("CSVファイルが見つかりません");
            const text = await response.text();
            const cards = parseCSV(text);
            const card = cards.find(c => c['カード名'] === targetName);

            if (!card) {
                contentDiv.innerHTML = `<p class="error">「${targetName}」が見つかりませんでした。</p><a href="javascript:window.close()" class="back-btn">閉じる</a>`;
                return;
            }

            // 除外する項目
            const excludeKeys = ['補足', '画像ファイル名', 'カード名', 'ID'];
            
            let tableRows = '';
            for (const key in card) {
                if (!excludeKeys.includes(key) && card[key]) {
                    tableRows += `<tr><th>${key}</th><td>${card[key]}</td></tr>`;
                }
            }
            
            // 画像ファイル名の処理（拡張子補完）
            let imgName = card['画像ファイル名'] || '';
            if(imgName && !imgName.includes('.')) imgName += '.png';

            contentDiv.innerHTML = `
                <div class="card-image-box">
                    <img src="images/${imgName}" alt="${card['カード名']}" class="card-image" onerror="this.style.display='none'">
                </div>
                <div class="card-info">
                    <h1>${card['カード名']}</h1>
                    <table>${tableRows}</table>
                    <a href="javascript:window.close()" class="back-btn">× タブを閉じる</a>
                </div>
            `;
        } catch (e) {
            contentDiv.innerHTML = `<p class="error">エラー: ${e.message}</p>`;
        }
    }
    init();
</script>
</body>
</html>
