<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crystal Frontier - Custom Builder</title>
    <style>
        /* =========================================
           â˜…ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚¨ãƒªã‚¢ (è¦‹ãŸç›®ã®è¨­å®š)
           ========================================= */
        :root {
            --card-w: 110px;
            --card-h: 154px;
            --bg: #0d1117;
            --panel: #161b22;
            --accent: #f1c40f; /* é‡‘è‰² */
            --text: #c9d1d9;
            --border: #30363d;
            --green: #238636;
            --red: #f85149;
            --blue: #1f6feb;
        }

        body { font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; font-size: 13px; }
        
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .screen { display: none; height: 100vh; width: 100vw; flex-direction: row; }
        .active { display: flex; }
        
        /* å·¦ãƒ‘ãƒãƒ« */
        .left-pane { 
            width: 450px; 
            min-width: 250px; 
            max-width: 80vw;
            border-right: none;
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            box-sizing: border-box; 
            flex-shrink: 0; 
        }

        /* ä»•åˆ‡ã‚Šç·š */
        .gutter {
            width: 8px;
            background: #21262d;
            cursor: col-resize;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            transition: background 0.2s;
            flex-shrink: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .gutter:hover, .gutter.dragging { background: var(--accent); }
        .gutter::after { content: "||"; color: #555; font-size: 9px; letter-spacing: -1px; }

        /* å³ãƒ‘ãƒãƒ« */
        .right-pane { 
            flex-grow: 1; 
            min-width: 0;
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            box-sizing: border-box; 
            background: #0d1117; 
        }
        
        /* æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼éƒ¨åˆ† */
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 8px; background: var(--panel); padding: 8px; border-radius: 6px; border: 1px solid var(--border); }
        .filter-grid label { grid-column: span 2; font-size: 10px; color: var(--accent); margin-top: 2px; font-weight: bold; }
        input, select, textarea { background: #0d1117; color: #fff; border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; font-size: 12px; height: 26px; box-sizing: border-box; }
        textarea { width: 100%; height: 80px; resize: none; margin-bottom: 10px; }
        .range-box { display: flex; align-items: center; gap: 3px; }
        .range-box input { width: 100%; }

        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¨­å®š */
        .check-group { display: flex; flex-wrap: wrap; gap: 4px; grid-column: span 2; margin-bottom: 4px; }
        .check-label {
            display: inline-block; cursor: pointer; font-size: 11px;
            background: #21262d; border: 1px solid var(--border);
            padding: 3px 8px; border-radius: 4px; color: var(--text); user-select: none; transition: 0.2s;
        }
        .check-label input { display: none; } 
        .check-label:has(input:checked) { background: var(--blue); color: #fff; border-color: var(--blue); }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        #search-results { flex-grow: 1; overflow-y: auto; background: #000; border: 1px solid var(--border); }
        #deck-list { 
            flex-grow: 1; overflow-y: auto; background: #000; padding: 10px; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, var(--card-w)); 
            gap: 12px; align-content: start; 
        }
        #play-area { flex-grow: 1; overflow-y: auto; background: #0a2012; border-radius: 8px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; padding: 20px; }

        /* ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .card-row { display: flex; padding: 6px; border-bottom: 1px solid var(--border); gap: 8px; background: #161b22; align-items: flex-start; }
        .card-row:hover { background: #21262d; }
        
        .img-box { width: 50px; height: 70px; background: #222; border: 1px solid #444; flex-shrink: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .img-box img { width: 100%; height: 100%; object-fit: contain; }
        
        .card-info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; gap: 2px; }
        
        .info-header { display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; margin-bottom: 2px; }
        .card-name { font-weight: bold; color: #fff; font-size: 14px; margin-bottom: 2px; }
        
        .card-sub { font-size: 11px; color: #8b949e; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
        
        .stat-emphasis {
            font-family: "Impact", "Arial Black", sans-serif;
            font-size: 15px;
            color: #fff;
            letter-spacing: 0.5px;
            margin-right: 4px;
        }

        /* åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
        .card-effect {
            font-size: 11px; color: #ccc; line-height: 1.4;
            background: rgba(0,0,0,0.3); padding: 4px; border-radius: 4px;
            max-height: 48px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #30363d;
        }
        .card-effect::-webkit-scrollbar { width: 4px; }
        .card-effect::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }

        .inline-icon { height: 1.1em; width: auto; vertical-align: text-bottom; margin: 0 1px; display: inline-block; }
        .btn-add { height: 100%; align-self: center; }

        /* ãƒ‡ãƒƒã‚­ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç­‰ */
        .deck-item { position: relative; width: var(--card-w); height: var(--card-h); cursor: pointer; }
        .deck-item img { 
            width: 100%; height: 100%; 
            border: 1px solid #fff; border-radius: 4px; object-fit: cover; transition: 0.1s;
        }
        .deck-item img:hover { border-color: var(--accent); opacity: 0.9; }
        .deck-item img:active { transform: scale(0.98); }
        .badge { position: absolute; top: -6px; right: -6px; background: var(--red); color: #fff; width: 22px; height: 22px; line-height: 22px; border-radius: 50%; font-weight: bold; text-align: center; border: 2px solid #fff; z-index: 10; font-size: 11px; pointer-events: none; }
        
        /* ã‚¹ãƒãƒ›ç”¨ãƒ‡ãƒƒã‚­æ“ä½œãƒœã‚¿ãƒ³ */
        .mobile-deck-controls {
            display: none; /* PCã§ã¯éš ã™ */
            position: absolute; bottom: 0; left: 0; width: 100%; height: 30px; z-index: 20;
            border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; overflow: hidden;
        }
        .ctrl-btn {
            width: 50%; height: 100%; border: none; color: #fff; font-weight: bold; font-size: 16px; cursor: pointer; padding: 0; margin: 0; float: left;
        }
        .ctrl-btn.minus { background: rgba(200, 50, 50, 0.8); }
        .ctrl-btn.minus:active { background: rgb(255, 0, 0); }
        .ctrl-btn.plus { background: rgba(50, 200, 50, 0.8); }
        .ctrl-btn.plus:active { background: rgb(0, 255, 0); }

        .play-card { width: 120px; height: 168px; border: 2px solid #fff; border-radius: 6px; background: #000; animation: drawAnim 0.3s ease-out; cursor: help; }
        
        #hover-preview { 
            position: fixed; z-index: 9999; pointer-events: none; display: none; 
            background: #000; border: 3px solid var(--accent); border-radius: 10px; 
            box-shadow: 0 0 30px rgba(0,0,0,0.9); width: 320px; height: 448px; 
            overflow: hidden; transition: opacity 0.3s; 
        }
        #hover-preview img { width: 100%; height: 100%; object-fit: contain; }

        /* â˜…è¿½åŠ : ã‚¹ãƒãƒ›æ‹¡å¤§æ™‚ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */
        #preview-close-btn {
            display: none; position: absolute; top: 5px; left: 5px; z-index: 10000;
            width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.8);
            color: #000; font-weight: bold; font-size: 20px; border: 2px solid #000;
            cursor: pointer; align-items: center; justify-content: center;
        }
        
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: #fff; font-size: 12px; }
        .btn-green { background: var(--green); } .btn-blue { background: var(--blue); } .btn-accent { background: var(--accent); color: #000; } .btn-red { background: var(--red); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        @keyframes drawAnim { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* =========================================
           â˜…ã‚¹ãƒãƒ›å¯¾å¿œ (ç”»é¢å¹…768pxä»¥ä¸‹ã§é©ç”¨)
           ========================================= */
        #mobile-nav { display: none; }
        #filter-toggle-btn { display: none; }
        #advanced-filters { display: grid; }

        @media (max-width: 768px) {
            /* ã‚¹ãƒãƒ›ç”¨ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚º (ç´„70%) */
            :root {
                --card-w: 75px;  
                --card-h: 105px;
            }
            .play-card { width: 75px; height: 105px; }

            .screen { flex-direction: column; height: calc(100vh - 50px); }
            
            .left-pane, .right-pane { 
                width: 100% !important; max-width: 100% !important; height: 100%; display: none; padding: 5px;
            }
            .left-pane.active-pane, .right-pane.active-pane { display: flex; }
            .gutter { display: none !important; }

            /* è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ */
            #advanced-filters { display: none; border-top: none; margin-top: -5px; }
            #filter-toggle-btn {
                display: block; width: 100%; padding: 8px; margin-bottom: 5px;
                background: #21262d; border: 1px solid #30363d; color: #8b949e;
                cursor: pointer; font-size: 12px; font-weight: bold; border-radius: 4px;
            }
            #filter-toggle-btn:hover { background: #30363d; color: #fff; }

            /* ãƒ›ãƒãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¹ãƒãƒ›ã§ã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¨ã—ã¦æ‰±ã†ï¼‰ */
            #hover-preview { 
                width: 100vw !important; height: 100vh !important; 
                top: 0 !important; left: 0 !important; border: none; border-radius: 0;
                transform: none; pointer-events: auto !important; /* ã‚¿ãƒƒãƒ—æœ‰åŠ¹åŒ– */
                background: rgba(0,0,0,0.85); /* èƒŒæ™¯æš—è»¢ */
                display: flex; align-items: center; justify-content: center;
                z-index: 9999;
            }
            #hover-preview img {
                width: auto; height: auto; max-width: 90vw; max-height: 80vh; 
                border: 2px solid var(--accent); border-radius: 8px;
            }
            
            /* ä¸‹éƒ¨ãƒŠãƒ“ */
            #mobile-nav {
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: 50px;
                background: #161b22; border-top: 1px solid #30363d; z-index: 2000;
            }
            .nav-btn {
                flex: 1; border: none; background: none; color: #8b949e; font-weight: bold;
                cursor: pointer; border-right: 1px solid #30363d; font-size: 14px;
            }
            .nav-btn:last-child { border-right: none; }
            .nav-btn.active { background: #1f6feb; color: #fff; }

            /* ã‚¹ãƒãƒ›ã ã‘ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º */
            .mobile-deck-controls { display: block; }
        }
    </style>
</head>
<body>
    <div id="hover-preview" onclick="closePreviewMobile()">
        <img id="preview-img" src="" onclick="event.stopPropagation()"> <div id="preview-close-btn" onclick="closePreviewMobile()">Ã—</div>
    </div>
    
    <div id="file-overlay" class="overlay" style="display: none;">
        <h2 style="color:var(--accent);">Crystal Frontier System</h2>
        <input type="file" id="csv-file" accept=".csv" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-green" onclick="loadFile('UTF-8')">UTF-8(æ¨å¥¨)</button>
            <button class="btn btn-blue" onclick="loadFile('Shift-JIS')">Shift-JIS(Excelç”¨)</button>
        </div>
    </div>

    <div id="screen-builder" class="screen active">
        <div class="left-pane" id="pane-l-build">
            <div class="filter-grid" style="margin-bottom: 5px; grid-template-columns: 1fr;">
                <input type="text" id="q-text" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»èª­ã¿(ã²ã‚‰ãŒãª)ã‚’å…¥åŠ›..." oninput="filterCards()" style="width:100%;">
            </div>

            <button id="filter-toggle-btn" onclick="toggleFilters()">â–¼ è©³ç´°æ¡ä»¶ã‚’æŒ‡å®šã™ã‚‹</button>

            <div class="filter-grid" id="advanced-filters">
                <label>åˆ†é¡ (è¤‡æ•°é¸æŠå¯)</label>
                <div class="check-group" id="grp-cat">
                    <label class="check-label"><input type="checkbox" value="01ãƒ¦ãƒ‹ãƒƒãƒˆ" onchange="filterCards()"> ãƒ¦ãƒ‹ãƒƒãƒˆ</label>
                    <label class="check-label"><input type="checkbox" value="02ãƒã‚¸ãƒƒã‚¯" onchange="filterCards()"> ãƒã‚¸ãƒƒã‚¯</label>
                    <label class="check-label"><input type="checkbox" value="ãƒ•ãƒ©ãƒƒã‚·ãƒ¥" onchange="filterCards()"> ãƒ•ãƒ©ãƒƒã‚·ãƒ¥</label>
                    <label class="check-label"><input type="checkbox" value="ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ" onchange="filterCards()"> ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</label>
                    <label class="check-label"><input type="checkbox" value="ã‚ªãƒ«ã‚¬ãƒãƒ³" onchange="filterCards()"> ã‚ªãƒ«ã‚¬ãƒãƒ³</label>
                </div>

                <label>è‰² (è¤‡æ•°é¸æŠå¯)</label>
                <div class="check-group" id="grp-col">
                    <label class="check-label"><input type="checkbox" value="èµ¤" onchange="filterCards()"> èµ¤</label>
                    <label class="check-label"><input type="checkbox" value="ç·‘" onchange="filterCards()"> ç·‘</label>
                    <label class="check-label"><input type="checkbox" value="é’" onchange="filterCards()"> é’</label>
                    <label class="check-label"><input type="checkbox" value="ç™½" onchange="filterCards()"> ç™½</label>
                    <label class="check-label"><input type="checkbox" value="é»’" onchange="filterCards()"> é»’</label>
                    <label class="check-label"><input type="checkbox" value="ç„¡" onchange="filterCards()"> ç„¡</label>
                    <label class="check-label"><input type="checkbox" value="å¤š" onchange="filterCards()"> å¤š</label>
                </div>

                <label>ã‚³ã‚¹ãƒˆ</label>
                <div class="range-box"><input type="number" id="q-cost-min" placeholder="0" oninput="filterCards()"><span>~</span><input type="number" id="q-cost-max" placeholder="âˆ" oninput="filterCards()"></div>
                
                <label>ãƒ¬ã‚¢ãƒªãƒ†ã‚£ (è¤‡æ•°é¸æŠå¯)</label>
                <div class="check-group" id="grp-rare">
                    <label class="check-label"><input type="checkbox" value="ã‚³ãƒ¢ãƒ³" onchange="filterCards()"> C</label>
                    <label class="check-label"><input type="checkbox" value="ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³" onchange="filterCards()"> UC</label>
                    <label class="check-label"><input type="checkbox" value="ãƒ¬ã‚¢" onchange="filterCards()"> R</label>
                    <label class="check-label"><input type="checkbox" value="ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰" onchange="filterCards()"> L</label>
                </div>
                
                <label>ATK / HP</label>
                <div class="range-box"><input type="number" id="q-atk-min" placeholder="0" oninput="filterCards()"><span>~</span><input type="number" id="q-atk-max" placeholder="âˆ" oninput="filterCards()"></div>
                <div class="range-box"><input type="number" id="q-hp-min" placeholder="0" oninput="filterCards()"><span>~</span><input type="number" id="q-hp-max" placeholder="âˆ" oninput="filterCards()"></div>
                
                <label>ä¸¦ã³æ›¿ãˆ</label>
                <div style="grid-column: span 2; display: flex; gap: 5px;">
                    <select id="q-sort-key" onchange="filterCards()" style="flex: 2;">
                        <option value="id">ID (ç™»éŒ²é †)</option>
                        <option value="name">åå‰ (ã‚ã„ã†ãˆãŠé †)</option>
                        <option value="costTotal">ã‚³ã‚¹ãƒˆ</option>
                        <option value="atk">ATK (æ”»æ’ƒåŠ›)</option>
                        <option value="hp">HP (ä½“åŠ›)</option>
                    </select>
                    <select id="q-sort-dir" onchange="filterCards()" style="flex: 1;">
                        <option value="1">æ˜‡é † (â–²)</option>
                        <option value="-1">é™é † (â–¼)</option>
                    </select>
                </div>
            </div>
            
            <div id="search-results"></div>
        </div>
        <div class="gutter" id="gutter-build"></div>
        
        <div class="right-pane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                <h3 style="margin:0;">Deck: <span id="total-count" style="color:var(--accent);">0</span>æš</h3>
                <div style="font-size:10px; color:#aaa;">(å·¦ã‚¯ãƒªãƒƒã‚¯:è¿½åŠ  / å³ã‚¯ãƒªãƒƒã‚¯:å‰Šé™¤)</div>
                <button class="btn btn-accent" onclick="switchToMulligan()">ä¸€äººå›ã— â”</button>
            </div>
            <div id="deck-list"></div>
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button class="btn btn-blue" onclick="copyRecipe()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btn-red" onclick="if(confirm('Reset?')){myDeck=[];renderDeck();}">Clear</button>
            </div>
        </div>
    </div>

    <div id="screen-mulligan" class="screen">
        <div class="left-pane" id="pane-l-mulligan">
            <button class="btn btn-blue" onclick="switchToBuilder()" style="margin-bottom:10px;">â† æ§‹ç¯‰ã¸æˆ»ã‚‹</button>
            <textarea id="manual-input" placeholder="Name x4..."></textarea>
            <div style="display: flex; gap: 5px; margin-bottom:10px;">
                <button class="btn btn-green" style="flex:1" onclick="applyManualList()">é©ç”¨</button>
                <button class="btn btn-blue" onclick="document.getElementById('recipe-upload').click()">èª­è¾¼</button>
                <input type="file" id="recipe-upload" accept=".txt" style="display:none;" onchange="handleRecipeUpload(event)">
            </div>
            <div class="filter-grid">
                <label>è¨­å®š</label>
                åˆæ‰‹æšæ•°: <input type="number" id="hand-size" value="5" min="1" max="10">
                <button class="btn btn-accent" style="grid-column:span 2; margin-top:10px;" onclick="initSim()">å±±æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦é–‹å§‹</button>
            </div>
        </div>
        <div class="gutter" id="gutter-mulligan"></div>

        <div class="right-pane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                <h3 style="margin:0;">Mulligan: å±±æœ­ <span id="sim-deck-count" style="color:var(--accent);">0</span>æš</h3>
                <button class="btn btn-green" onclick="drawOne()">ãƒ‰ãƒ­ãƒ¼</button>
            </div>
            <div id="play-area"></div>
        </div>
    </div>

    <div id="mobile-nav">
        <button class="nav-btn active" id="btn-search" onclick="showMobilePane('left')">ğŸ” ã‚«ãƒ¼ãƒ‰æ¤œç´¢ / è¨­å®š</button>
        <button class="nav-btn" id="btn-deck" onclick="showMobilePane('right')">ğŸƒ ãƒ‡ãƒƒã‚­ / ãƒ—ãƒ¬ã‚¤</button>
    </div>

    <script>
        const CONFIG = {
            maxCardsInDeck: 4,
            defaultHandSize: 7,
            defaultCostMax: 999,
            defaultStatMax: 99999
        };

        let MASTER_DB = [], myDeck = [], simDeck = [], hoverTimer = null;
        // PC/ãƒ¢ãƒã‚¤ãƒ«åˆ¤å®š (å¹…768pxä»¥ä¸‹ã‚’ãƒ¢ãƒã‚¤ãƒ«ã¨ã™ã‚‹)
        const isMobile = () => window.innerWidth <= 768;

        // --- åˆæœŸåŒ–å‡¦ç† ---
        window.addEventListener('DOMContentLoaded', () => {
            setupResizer('pane-l-build', 'gutter-build');
            setupResizer('pane-l-mulligan', 'gutter-mulligan');

            showMobilePane('left'); 

            fetch('card_list.csv')
                .then(response => {
                    if (!response.ok) throw new Error("CSVãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    return response.text();
                })
                .then(text => {
                    parseCSV(text);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\ncard_list.csv ãŒåŒã˜å ´æ‰€ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                });
        });

        // ã‚¹ãƒãƒ›è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
        function showMobilePane(side) {
            const activeScreen = document.querySelector('.screen.active');
            if (!activeScreen) return;

            const left = activeScreen.querySelector('.left-pane');
            const right = activeScreen.querySelector('.right-pane');
            const btnSearch = document.getElementById('btn-search');
            const btnDeck = document.getElementById('btn-deck');

            if (side === 'left') {
                left.classList.add('active-pane');
                right.classList.remove('active-pane');
                btnSearch.classList.add('active');
                btnDeck.classList.remove('active');
            } else {
                left.classList.remove('active-pane');
                right.classList.add('active-pane');
                btnSearch.classList.remove('active');
                btnDeck.classList.add('active');
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿é–‹é–‰ãƒœã‚¿ãƒ³ã®å‹•ä½œ
        function toggleFilters() {
            const area = document.getElementById('advanced-filters');
            const btn = document.getElementById('filter-toggle-btn');
            const isClosed = window.getComputedStyle(area).display === 'none';
            
            if (isClosed) {
                area.style.display = 'grid';
                btn.textContent = 'â–² è©³ç´°æ¡ä»¶ã‚’é–‰ã˜ã‚‹';
                btn.style.background = '#30363d';
                btn.style.color = '#fff';
            } else {
                area.style.display = 'none';
                btn.textContent = 'â–¼ è©³ç´°æ¡ä»¶ã‚’æŒ‡å®šã™ã‚‹';
                btn.style.background = '#21262d';
                btn.style.color = '#8b949e';
            }
        }

        function setupResizer(leftId, gutterId) {
            const leftPane = document.getElementById(leftId);
            const gutter = document.getElementById(gutterId);
            let isDragging = false;

            gutter.addEventListener('mousedown', (e) => {
                isDragging = true;
                gutter.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                let newWidth = e.clientX;
                if (newWidth < 200) newWidth = 200;
                if (newWidth > window.innerWidth - 100) newWidth = window.innerWidth - 100;
                leftPane.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    gutter.classList.remove('dragging');
                    document.body.style.cursor = 'default';
                }
            });
        }

        // â˜…ã‚¹ãƒãƒ›ç”¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹é–¢æ•°
        function closePreviewMobile() {
            const p = document.getElementById('hover-preview');
            const btn = document.getElementById('preview-close-btn');
            p.style.display = 'none';
            btn.style.display = 'none';
        }

        function enablePreview(el, src) {
            if (isMobile()) {
                // â˜…ã‚¹ãƒãƒ›: ã‚¿ãƒƒãƒ—ã§æ‹¡å¤§è¡¨ç¤ºï¼ˆé–‰ã˜ã‚‹ã¾ã§æ¶ˆãˆãªã„ï¼‰
                el.onclick = (e) => {
                    const p = document.getElementById('hover-preview');
                    const img = document.getElementById('preview-img');
                    const btn = document.getElementById('preview-close-btn');
                    
                    img.src = src;
                    p.style.display = 'flex'; // ã‚¹ãƒãƒ›ç”¨CSSã§å…¨ç”»é¢ä¸­å¤®é…ç½®
                    p.style.opacity = '1';
                    btn.style.display = 'flex';
                    e.stopPropagation();
                };
            } else {
                // â˜…PC: ãƒ›ãƒãƒ¼ã§è¿½å¾“è¡¨ç¤º
                el.onmouseenter = (e) => {
                    hoverTimer = setTimeout(() => {
                        const p = document.getElementById('hover-preview');
                        document.getElementById('preview-img').src = src;
                        p.style.display = 'block';
                        p.style.opacity = '1';
                        updatePreviewPos(e);
                    }, 300);
                };
                el.onmousemove = (e) => updatePreviewPos(e);
                el.onmouseleave = () => { 
                    clearTimeout(hoverTimer); 
                    document.getElementById('hover-preview').style.display = 'none'; 
                };
            }
        }
        
        function updatePreviewPos(e) {
            if (isMobile()) return; // ã‚¹ãƒãƒ›ã§ã¯ä½ç½®è¨ˆç®—ã—ãªã„
            const p = document.getElementById('hover-preview');
            const offset = 20; const pW = 320, pH = 448;
            let x = e.clientX + offset, y = e.clientY + offset;
            if (x + pW > window.innerWidth) x = e.clientX - pW - offset;
            if (y + pH > window.innerHeight) y = e.clientY - pH - offset;
            p.style.left = Math.max(0, x) + 'px'; p.style.top = Math.max(0, y) + 'px';
        }

        function loadFile(enc) { const f=document.getElementById('csv-file').files[0]; if(!f)return; const r=new FileReader(); r.onload=(e)=>{ parseCSV(e.target.result); document.getElementById('file-overlay').style.display='none'; }; r.readAsText(f,enc); }
        
        function parseCSV(txt) {
            const lines = txt.split(/\r?\n/);
            MASTER_DB = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim(); if(!line) continue;
                const cells = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (cells.length < 16) continue;
                
                const clean = (str) => {
                    let s = (str || "").trim();
                    if (s.startsWith('"') && s.endsWith('"')) {
                        s = s.slice(1, -1).replace(/""/g, '"');
                    }
                    return s;
                };

                let fName = clean(cells[16]);
                if (fName && !fName.includes(".")) fName += ".png";
                
                const name = clean(cells[0]);
                const category = clean(cells[3]);
                const type = clean(cells[4]);
                const reading = clean(cells[17]); 
                
                const rawEffects = [cells[11], cells[12], cells[13], cells[14]];
                const effect = rawEffects
                    .map(t => clean(t))
                    .filter(t => t !== "" && t !== "-" && t !== "â€")
                    .join("\n");

                const toHira = (str) => str.replace(/[\u30a1-\u30f6]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60));

                const rawText = name + reading + type + category + effect;
                const searchText = (rawText + toHira(rawText)).toLowerCase();

                MASTER_DB.push({
                    id: i,
                    name: name,
                    reading: reading, 
                    color: clean(cells[1]), rarity: clean(cells[2]), category: category, type: type,
                    costTotal: parseInt(clean(cells[6])) || 0,
                    atk: parseInt(clean(cells[8])) || 0, hp: parseInt(clean(cells[9])) || 0,
                    effect: effect, 
                    fileName: fName,
                    searchText: searchText 
                });
            }
            document.getElementById('hand-size').value = CONFIG.defaultHandSize;
            filterCards();
        }

        function filterCards() {
            const getChecked = (id) => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(e => e.value);
            const getNum = (id, defaultVal) => {
                const val = document.getElementById(id).value;
                return val === "" ? defaultVal : parseInt(val);
            };

            const q = {
                text: document.getElementById('q-text').value.toLowerCase().trim(),
                cats: getChecked('grp-cat'),
                cols: getChecked('grp-col'),
                rares: getChecked('grp-rare'),
                cMin: getNum('q-cost-min', 0),
                cMax: getNum('q-cost-max', CONFIG.defaultCostMax),
                aMin: getNum('q-atk-min', 0),
                aMax: getNum('q-atk-max', CONFIG.defaultStatMax),
                hMin: getNum('q-hp-min', 0),
                hMax: getNum('q-hp-max', CONFIG.defaultStatMax)
            };

            let filtered = MASTER_DB.filter(c => {
                if (!c.searchText.includes(q.text)) return false;
                if (q.cats.length > 0 && !q.cats.some(cat => c.category.includes(cat))) return false;
                if (q.cols.length > 0 && !q.cols.some(col => c.color.includes(col))) return false;
                if (q.rares.length > 0 && !q.rares.some(r => c.rarity === r)) return false;
                if (c.costTotal < q.cMin || c.costTotal > q.cMax) return false;
                if (c.atk < q.aMin || c.atk > q.aMax) return false;
                if (c.hp < q.hMin || c.hp > q.hMax) return false;
                return true;
            });

            const sortKey = document.getElementById('q-sort-key').value;
            const sortDir = parseInt(document.getElementById('q-sort-dir').value);

            filtered.sort((a, b) => {
                if (sortKey === 'name') {
                    const valA = a.reading || a.name;
                    const valB = b.reading || b.name;
                    return String(valA).localeCompare(String(valB), 'ja') * sortDir;
                }
                const valA = a[sortKey] || 0;
                const valB = b[sortKey] || 0;
                return (valA - valB) * sortDir;
            });

            renderResults(filtered);
        }

        function formatEffect(text) {
            if (!text) return "";
            let normalized = text.replace(/ï¼ˆ/g, '(').replace(/ï¼‰/g, ')');
            return normalized.replace(/\(([^)]{1,15})\)/g, (match, content) => {
                const cleanContent = content.trim();
                return `<img src="images/icons/${cleanContent}.png" class="inline-icon" alt="${match}" onerror="this.style.display='none';this.insertAdjacentText('afterend','${match}')">`;
            });
        }

        function renderResults(list) {
            const area = document.getElementById('search-results');
            area.innerHTML = '';
            
            // ã‚¹ãƒãƒ›ã‹PCã‹åˆ¤å®š
            const mobile = isMobile();

            list.forEach(c => {
                const safeName = c.name.replace(/'/g, "\\'");
                const div = document.createElement('div');
                div.className = 'card-row';
                
                const effectHtml = formatEffect(c.effect);
                const effectPart = effectHtml 
                    ? `<div class="card-effect">${effectHtml}</div>` 
                    : ""; 

                let infoParts = [];
                let statHtml = "";
                let hasStat = false;
                if ((c.category && c.category.includes("ãƒ¦ãƒ‹ãƒƒãƒˆ")) || c.atk > 0 || c.hp > 0) {
                     statHtml = `<span class="stat-emphasis">${c.atk}/${c.hp}</span>`;
                     hasStat = true;
                }

                if (c.category) infoParts.push(c.category);
                if (c.color) infoParts.push(c.color);
                if (c.type && c.type !== "-" && c.type !== "â€") {
                    infoParts.push(c.type);
                }
                
                let subInfoHtml = "";
                if (hasStat) {
                    subInfoHtml = statHtml;
                    if (infoParts.length > 0) {
                        subInfoHtml += " | " + infoParts.join(" | ");
                    }
                } else {
                    subInfoHtml = infoParts.join(" | ");
                }

                // â˜…PCãªã‚‰ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼ˆã‚¹ãƒãƒ›ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã«ä»»ã›ã‚‹ã®ã§ã“ã“ã«ã¯æ›¸ã‹ãªã„ï¼‰
                const imgClickAction = mobile ? "" : `onclick="addToDeck('${safeName}')"`;

                div.innerHTML = `
                    <div class="img-box" ${imgClickAction}>
                        <img src="images/${c.fileName}" onerror="this.src='https://via.placeholder.com/50x70?text=NoImg'">
                    </div>
                    <div class="card-info">
                        <div class="info-header">
                            <span class="card-name">${c.name}</span>
                            <span class="card-sub">${subInfoHtml}</span>
                        </div>
                        ${effectPart}
                    </div>
                    <button class="btn btn-green btn-add" onclick="addToDeck('${safeName}')">+</button>
                `;
                enablePreview(div.querySelector('.img-box img'), `images/${c.fileName}`);
                area.appendChild(div);
            });
        }

        function addToDeck(name) {
            const master = MASTER_DB.find(d => d.name === name);
            const inDeck = myDeck.find(d => d.name === name);
            if (inDeck) {
                if (inDeck.count >= CONFIG.maxCardsInDeck) return;
                inDeck.count++;
            } else {
                myDeck.push({...master, count: 1});
            }
            myDeck.sort((a,b) => a.id - b.id);
            renderDeck();
        }

        function renderDeck() {
            const area = document.getElementById('deck-list');
            area.innerHTML = '';
            let total = 0;
            const mobile = isMobile();

            myDeck.forEach(d => {
                total += d.count;
                const safeName = d.name.replace(/'/g, "\\'");
                const div = document.createElement('div');
                div.className = 'deck-item';
                
                // â˜…PCãªã‚‰ç”»åƒæ“ä½œæœ‰åŠ¹ã€ã‚¹ãƒãƒ›ãªã‚‰ç„¡åŠ¹(ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿)
                const imgAction = mobile ? "" : `onclick="addToDeck('${safeName}')" oncontextmenu="event.preventDefault(); removeFromDeck('${safeName}')"`;
                
                // â˜…ã‚¹ãƒãƒ›ãªã‚‰æ“ä½œãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                const mobileControls = mobile ? `
                    <div class="mobile-deck-controls">
                        <button class="ctrl-btn minus" onclick="event.stopPropagation(); removeFromDeck('${safeName}')">ï¼</button>
                        <button class="ctrl-btn plus" onclick="event.stopPropagation(); addToDeck('${safeName}')">ï¼‹</button>
                    </div>
                ` : "";

                div.innerHTML = `
                    <div class="badge">${d.count}</div>
                    <img src="images/${d.fileName}" ${imgAction}>
                    ${mobileControls}
                `;
                enablePreview(div.querySelector('img'), `images/${d.fileName}`);
                area.appendChild(div);
            });
            document.getElementById('total-count').textContent = total;
        }

        function removeFromDeck(name) {
            const inDeck = myDeck.find(d => d.name === name);
            if (inDeck) {
                inDeck.count--;
                if (inDeck.count <= 0) myDeck = myDeck.filter(d => d.name !== name);
            }
            renderDeck();
        }

        function switchToMulligan() { 
            document.getElementById('screen-builder').classList.remove('active'); 
            document.getElementById('screen-mulligan').classList.add('active'); 
            document.getElementById('manual-input').value = myDeck.map(d => `${d.name} x${d.count}`).join("\n"); 
            showMobilePane('left'); 
        }
        function switchToBuilder() { 
            document.getElementById('screen-mulligan').classList.remove('active'); 
            document.getElementById('screen-builder').classList.add('active'); 
            showMobilePane('left'); 
        }
        
        function applyManualList() {
            const input = document.getElementById('manual-input').value; myDeck = [];
            input.split("\n").forEach(line => {
                let match = line.match(/^(.+?)\s*[xÃ—*]\s*(\d+)$/);
                let name = match ? match[1].trim() : line.trim(); let count = match ? parseInt(match[2]) : 1;
                let master = MASTER_DB.find(m => m.name === name);
                if (master) myDeck.push({...master, count: Math.min(count, CONFIG.maxCardsInDeck)});
            });
            renderDeck();
        }
        function handleRecipeUpload(e) { const file=e.target.files[0]; const reader=new FileReader(); reader.onload=(ev)=>{ document.getElementById('manual-input').value=ev.target.result; applyManualList(); }; reader.readAsText(file); }
        
        function initSim() {
            simDeck = []; myDeck.forEach(card => { for (let i = 0; i < card.count; i++) simDeck.push({...card}); });
            if (simDeck.length < 1) return alert("ãƒ‡ãƒƒã‚­ãŒç©ºã§ã™");
            for (let i = simDeck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [simDeck[i], simDeck[j]] = [simDeck[j], simDeck[i]]; }
            document.getElementById('play-area').innerHTML = '';
            const hSize = parseInt(document.getElementById('hand-size').value);
            for (let i = 0; i < hSize; i++) drawOne();
            updateSimCount();
            if (isMobile()) showMobilePane('right');
        }
        function drawOne() {
            if (simDeck.length === 0) return; const card = simDeck.pop();
            const img = document.createElement('img'); img.src = `images/${card.fileName}`; img.className = 'play-card';
            enablePreview(img, `images/${card.fileName}`); 
            // ãƒãƒªã‚¬ãƒ³ç”»é¢ã¯PCã§ã‚‚ã‚¹ãƒãƒ›ã§ã‚‚ã‚¯ãƒªãƒƒã‚¯ã§æ¶ˆã™æŒ™å‹•ã¯å…±é€šã§OKã ãŒã€ã‚¹ãƒãƒ›ã¯æ‹¡å¤§ã‚‚ã—ãŸã„
            // ãŸã ã—ç¾çŠ¶ã®ã‚³ãƒ¼ãƒ‰ã ã¨ã‚¹ãƒãƒ›ã¯æ‹¡å¤§å„ªå…ˆã€PCã¯ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤ã«ãªã£ã¦ã„ã‚‹
            if (!isMobile()) {
                img.onclick = () => img.remove();
            } else {
                // ã‚¹ãƒãƒ›ã®ãƒãƒªã‚¬ãƒ³ç”»é¢ï¼šã‚¿ãƒƒãƒ—ã§æ‹¡å¤§ï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ã‚’åˆ¥é€”ã¤ã‘ã‚‹ã‹ã€æ‹¡å¤§ç”»é¢ã«å‰Šé™¤æ©Ÿèƒ½ã¤ã‘ã‚‹ã‹ã ãŒã€ç¾çŠ¶ã¯ã€Œæ‹¡å¤§å„ªå…ˆã€ã¨ã™ã‚‹ï¼‰
                // â€»ãƒãƒªã‚¬ãƒ³ã§ã®ã‚«ãƒ¼ãƒ‰å‰Šé™¤ã¯ã€Œç›¤é¢ã‹ã‚‰å–ã‚Šé™¤ãã€æ„å‘³åˆã„ãªã®ã§ã€ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‹é•·æŠ¼ã—ã«ã™ã‚‹æ‰‹ã‚‚ã‚ã‚‹ãŒ
                // ã„ã£ãŸã‚“ã€Œã‚¿ãƒƒãƒ—ï¼æ‹¡å¤§ã€ã®çµ±ä¸€æ“ä½œã¨ã™ã‚‹ã€‚
            }
            
            document.getElementById('play-area').appendChild(img); updateSimCount();
        }
        function updateSimCount() { document.getElementById('sim-deck-count').textContent = simDeck.length; }
        function copyRecipe() { let txt = myDeck.map(d => `${d.name} x${d.count}`).join("\n"); navigator.clipboard.writeText(txt).then(() => alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼")); }
    </script>
</body>
</html>
