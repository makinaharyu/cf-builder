<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>ãƒ‡ãƒƒã‚­ãƒ“ãƒ«ãƒ€ãƒ¼ | ã‚¯ãƒªãƒ•ãƒ­-Crystal Frontier-</title>
    <style>
        /* =========================================
           â˜…ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚¨ãƒªã‚¢ (è¦‹ãŸç›®ã®è¨­å®š)
           ã“ã“ã‚’æ›¸ãæ›ãˆã‚‹ã ã‘ã§å…¨ä½“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ãŒå¤‰ã‚ã‚Šã¾ã™
           ========================================= */
        :root {
            /* --- åŸºæœ¬ã‚«ãƒ©ãƒ¼ --- */
            --bg: #0d1117;           /* èƒŒæ™¯è‰² */
            --panel: #161b22;        /* ãƒ‘ãƒãƒ«èƒŒæ™¯è‰² */
            --accent: #f1c40f;       /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆé‡‘ï¼‰ */
            --text: #c9d1d9;         /* æ–‡å­—è‰²ï¼ˆé€šå¸¸ï¼‰ */
            --text-bright: #ffffff;  /* æ–‡å­—è‰²ï¼ˆå¼·èª¿ï¼‰ */
            --border: #30363d;       /* å¢ƒç•Œç·š */
            
            /* --- çŠ¶æ…‹ã‚«ãƒ©ãƒ¼ --- */
            --green: #238636;        /* è¿½åŠ ãƒ»æˆåŠŸ */
            --red: #f85149;          /* å‰Šé™¤ãƒ»è­¦å‘Š */
            --blue: #1f6feb;         /* é¸æŠãƒ»æƒ…å ± */
            --board-bg: #0a2012;     /* ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢ã®èƒŒæ™¯è‰² */

            /* --- ã‚«ãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚ºè¨­å®š --- */
            --card-w: 110px;         /* PCç‰ˆã‚«ãƒ¼ãƒ‰æ¨ªå¹… */
            --card-h: 154px;         /* PCç‰ˆã‚«ãƒ¼ãƒ‰ç¸¦å¹… */
            --card-w-sm: 75px;       /* ã‚¹ãƒãƒ›ç‰ˆã‚«ãƒ¼ãƒ‰æ¨ªå¹… */
            --card-h-sm: 105px;      /* ã‚¹ãƒãƒ›ç‰ˆã‚«ãƒ¼ãƒ‰ç¸¦å¹… */
            --card-radius: 6px;      /* ã‚«ãƒ¼ãƒ‰ã®è§’ä¸¸ */

            /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š --- */
            --sidebar-w: 450px;      /* PCç‰ˆã®å·¦ãƒ‘ãƒãƒ«åˆæœŸå¹… */
            --gutter-w: 8px;         /* ä»•åˆ‡ã‚Šç·šã®å¹… */
            --nav-h: 50px;           /* ã‚¹ãƒãƒ›ç‰ˆãƒŠãƒ“ã®é«˜ã• */
            
            /* --- ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š --- */
            --font-main: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
            --font-stat: "Impact", "Arial Black", sans-serif; /* æ•°å€¤ç”¨ã®ãƒ•ã‚©ãƒ³ãƒˆ */
        }

        /* å…¨ä½“è¨­å®š */
        body { 
            font-family: var(--font-main);
            background: var(--bg); color: var(--text); 
            margin: 0; padding: 0; overflow: hidden; font-size: 13px;
            touch-action: manipulation; width: 100%; height: 100dvh;
        }
        
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .screen { display: none; height: 100dvh; width: 100%; flex-direction: row; }
        .active { display: flex; }
        
        /* å·¦ãƒ‘ãƒãƒ« */
        .left-pane { 
            width: var(--sidebar-w); min-width: 250px; max-width: 80vw;
            border-right: none; padding: 10px; display: flex; 
            flex-direction: column; box-sizing: border-box; flex-shrink: 0; 
        }

        /* ä»•åˆ‡ã‚Šç·š */
        .gutter {
            width: var(--gutter-w); background: #21262d; cursor: col-resize;
            border-left: 1px solid var(--border); border-right: 1px solid var(--border);
            transition: background 0.2s; flex-shrink: 0; z-index: 100;
            display: flex; align-items: center; justify-content: center;
        }
        .gutter:hover, .gutter.dragging { background: var(--accent); }
        .gutter::after { content: "||"; color: #555; font-size: 9px; letter-spacing: -1px; }

        /* å³ãƒ‘ãƒãƒ« */
        .right-pane { 
            flex-grow: 1; min-width: 0; padding: 10px; display: flex; 
            flex-direction: column; box-sizing: border-box; background: var(--bg); 
        }
        
        /* æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼éƒ¨åˆ† */
        .filter-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 8px; 
            background: var(--panel); padding: 8px; border-radius: 6px; border: 1px solid var(--border); 
        }
        .filter-grid label { grid-column: span 2; font-size: 10px; color: var(--accent); margin-top: 2px; font-weight: bold; }
        input, select, textarea { background: var(--bg); color: #fff; border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; font-size: 12px; height: 26px; box-sizing: border-box; }
        textarea { width: 100%; height: 80px; resize: none; margin-bottom: 10px; }
        .range-box { display: flex; align-items: center; gap: 3px; }
        .range-box input { width: 100%; }

        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¨­å®š */
        .check-group { display: flex; flex-wrap: wrap; gap: 4px; grid-column: span 2; margin-bottom: 4px; }
        .check-label {
            display: inline-block; cursor: pointer; font-size: 11px;
            background: #21262d; border: 1px solid var(--border);
            padding: 3px 8px; border-radius: 4px; color: var(--text); user-select: none; transition: 0.2s;
        }
        .check-label input { display: none; } 
        .check-label:has(input:checked) { background: var(--blue); color: #fff; border-color: var(--blue); }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        #search-results { flex-grow: 1; overflow-y: auto; overflow-x: hidden; background: #000; border: 1px solid var(--border); }
        #deck-list { 
            flex-grow: 1; overflow-y: auto; overflow-x: hidden; background: #000; padding: 10px; 
            display: grid; grid-template-columns: repeat(auto-fill, var(--card-w)); 
            gap: 12px; align-content: start; 
        }
        #play-area { 
            flex-grow: 1; overflow-y: auto; overflow-x: hidden; background: var(--board-bg); 
            border-radius: 8px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; padding: 20px; 
        }

        /* ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .card-row { display: flex; padding: 6px; border-bottom: 1px solid var(--border); gap: 8px; background: var(--panel); align-items: flex-start; }
        .card-row:hover { background: #21262d; }
        .img-box { width: 50px; height: 70px; background: #222; border: 1px solid #444; flex-shrink: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .img-box img { width: 100%; height: 100%; object-fit: contain; }
        .card-info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; gap: 2px; }
        .info-header { display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; margin-bottom: 2px; min-width: 0; }
        .card-name { 
            font-weight: bold; color: var(--text-bright); font-size: 14px; margin-bottom: 2px; 
            width: 100%; overflow-x: auto; white-space: nowrap; scrollbar-width: none;
        }
        .card-sub { font-size: 11px; color: #8b949e; display: flex; align-items: center; width: 100%; overflow: hidden; }
        .stat-emphasis { font-family: var(--font-stat); font-size: 15px; color: var(--text-bright); letter-spacing: 0.5px; flex-shrink: 0; }
        .info-scroll-area { flex-grow: 1; overflow-x: auto; white-space: nowrap; scrollbar-width: none; margin-left: 4px; }

        /* åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
        .card-effect {
            font-size: 11px; color: #ccc; line-height: 1.4;
            background: rgba(0,0,0,0.3); padding: 4px; border-radius: 4px;
            max-height: 48px; overflow-y: auto; white-space: pre-wrap; border: 1px solid var(--border);
        }
        .inline-icon { height: 1.1em; width: auto; vertical-align: text-bottom; margin: 0 1px; display: inline-block; }
        
        .btn-add { height: 100%; align-self: center; flex-shrink: 0; }

        /* ãƒ‡ãƒƒã‚­å†…ã‚«ãƒ¼ãƒ‰ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .deck-item { position: relative; width: var(--card-w); height: var(--card-h); cursor: pointer; }
        .deck-item img { width: 100%; height: 100%; border: 1px solid #fff; border-radius: var(--card-radius); object-fit: cover; transition: 0.1s; }
        .badge { position: absolute; top: -6px; right: -6px; background: var(--red); color: #fff; width: 22px; height: 22px; line-height: 22px; border-radius: 50%; font-weight: bold; text-align: center; border: 2px solid #fff; z-index: 10; font-size: 11px; pointer-events: none; }
        .deck-controls { position: absolute; bottom: 0; left: 0; width: 100%; height: 30px; z-index: 20; border-bottom-left-radius: var(--card-radius); border-bottom-right-radius: var(--card-radius); overflow: hidden; display: flex; }
        .ctrl-btn { width: 50%; height: 100%; border: none; color: #fff; font-weight: bold; font-size: 16px; cursor: pointer; padding: 0; margin: 0; }
        .ctrl-btn.minus { background: rgba(200, 50, 50, 0.8); }
        .ctrl-btn.plus { background: rgba(50, 200, 50, 0.8); }

        .play-card { width: var(--card-w); height: var(--card-h); border: 2px solid #fff; border-radius: var(--card-radius); background: #000; animation: drawAnim 0.3s ease-out; cursor: help; }
        
        #hover-preview { 
            position: fixed; z-index: 9999; pointer-events: none; display: none; 
            background: #000; border: 3px solid var(--accent); border-radius: 10px; 
            box-shadow: 0 0 30px rgba(0,0,0,0.9); width: 320px; height: 448px; 
            overflow: hidden; transition: opacity 0.3s; 
        }
        #hover-preview img { width: 100%; height: 100%; object-fit: contain; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: #fff; font-size: 12px; }
        .btn-green { background: var(--green); } .btn-blue { background: var(--blue); } .btn-accent { background: var(--accent); color: #000; } .btn-red { background: var(--red); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        @keyframes drawAnim { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .nav-badge {
            display: inline-block;
            background: #ffffff;
            color: #000000;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            margin-left: 6px;
            padding: 0 2px;
        }

        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 768px) {
            .pc-only-text { display: none !important; }
            .screen { height: calc(100dvh - var(--nav-h)); flex-direction: column; }
            .left-pane, .right-pane { width: 100% !important; max-width: 100% !important; height: 100%; display: none; padding: 10px 5px; box-sizing: border-box; }
            .left-pane.active-pane, .right-pane.active-pane { display: flex; }
            .gutter { display: none !important; }
            #deck-list { grid-template-columns: repeat(auto-fill, var(--card-w-sm)); gap: 8px; }
            .deck-item { width: var(--card-w-sm); height: var(--card-h-sm); }
            .play-card { width: var(--card-w-sm); height: var(--card-h-sm); }
            #filter-toggle-btn { display: block; width: 100%; padding: 8px; margin-bottom: 5px; background: #21262d; border: 1px solid var(--border); color: #8b949e; font-size: 12px; border-radius: 4px; }
            #advanced-filters { display: none; }
            #mobile-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-h); background: var(--panel); border-top: 1px solid var(--border); z-index: 2000; padding-bottom: env(safe-area-inset-bottom, 0px); }
            .nav-btn { flex: 1; border: none; background: none; color: #8b949e; font-weight: bold; cursor: pointer; border-right: 1px solid var(--border); font-size: 13px; display: flex; align-items: center; justify-content: center; }
            .nav-btn.active { background: var(--blue); color: #fff; }
            #hover-preview { width: 100vw !important; height: 100dvh !important; top: 0 !important; left: 0 !important; border-radius: 0; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        }
    </style>
</head>
<body>
    <div id="hover-preview" onclick="closePreviewMobile()">
        <img id="preview-img" src="" onclick="event.stopPropagation()">
        <div id="preview-close-btn" style="display:none; position:absolute; top:10px; right:10px; font-size:30px; color:#fff;">Ã—</div>
    </div>
    
    <div id="file-overlay" class="overlay" style="display: none;">
        <h2 style="color:var(--accent);">Crystal Frontier System</h2>
        <input type="file" id="csv-file" accept=".csv" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-green" onclick="loadFile('UTF-8')">UTF-8(æ¨å¥¨)</button>
            <button class="btn btn-blue" onclick="loadFile('Shift-JIS')">Shift-JIS(Excelç”¨)</button>
        </div>
    </div>

    <div id="screen-builder" class="screen active">
        <div class="left-pane" id="pane-l-build">
            <div class="filter-grid" style="margin-bottom: 5px; grid-template-columns: 1fr;">
                <input type="text" id="q-text" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»èª­ã¿(ã²ã‚‰ãŒãª)ã‚’å…¥åŠ›..." oninput="filterCards()" style="width:100%;">
            </div>

            <button id="filter-toggle-btn" onclick="toggleFilters()">â–¼ è©³ç´°æ¡ä»¶ã‚’æŒ‡å®šã™ã‚‹</button>

            <div class="filter-grid" id="advanced-filters">
                <label>åˆ†é¡ (è¤‡æ•°é¸æŠå¯)</label>
                <div class="check-group" id="grp-cat">
                    <label class="check-label"><input type="checkbox" value="ãƒ¦ãƒ‹ãƒƒãƒˆ" onchange="filterCards()"> ãƒ¦ãƒ‹ãƒƒãƒˆ</label>
                    <label class="check-label"><input type="checkbox" value="ãƒã‚¸ãƒƒã‚¯" onchange="filterCards()"> ãƒã‚¸ãƒƒã‚¯</label>
                    <label class="check-label"><input type="checkbox" value="ãƒ•ãƒ©ãƒƒã‚·ãƒ¥" onchange="filterCards()"> ãƒ•ãƒ©ãƒƒã‚·ãƒ¥</label>
                    <label class="check-label"><input type="checkbox" value="ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ" onchange="filterCards()"> ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</label>
                    <label class="check-label"><input type="checkbox" value="ã‚ªãƒ«ã‚¬ãƒãƒ³" onchange="filterCards()"> ã‚ªãƒ«ã‚¬ãƒãƒ³</label>
                </div>

                <label>è‰² (è¤‡æ•°é¸æŠå¯)</label>
                <div class="check-group" id="grp-col">
                    <label class="check-label"><input type="checkbox" value="èµ¤" onchange="filterCards()"> èµ¤</label>
                    <label class="check-label"><input type="checkbox" value="ç·‘" onchange="filterCards()"> ç·‘</label>
                    <label class="check-label"><input type="checkbox" value="é’" onchange="filterCards()"> é’</label>
                    <label class="check-label"><input type="checkbox" value="ç™½" onchange="filterCards()"> ç™½</label>
                    <label class="check-label"><input type="checkbox" value="é»’" onchange="filterCards()"> é»’</label>
                    <label class="check-label"><input type="checkbox" value="ç„¡" onchange="filterCards()"> ç„¡</label>
                    <label class="check-label"><input type="checkbox" value="å¤š" onchange="filterCards()"> å¤š</label>
                </div>

                <label>ã‚³ã‚¹ãƒˆ</label>
                <div class="range-box">
                    <input type="number" id="q-cost-min" placeholder="0" oninput="filterCards()">
                    <span>~</span>
                    <input type="number" id="q-cost-max" placeholder="âˆ" oninput="filterCards()">
                </div>
                
                <label>ãƒ¬ã‚¢ãƒªãƒ†ã‚£</label>
                <div class="check-group" id="grp-rare">
                    <label class="check-label"><input type="checkbox" value="ã‚³ãƒ¢ãƒ³" onchange="filterCards()"> C</label>
                    <label class="check-label"><input type="checkbox" value="ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³" onchange="filterCards()"> UC</label>
                    <label class="check-label"><input type="checkbox" value="ãƒ¬ã‚¢" onchange="filterCards()"> R</label>
                    <label class="check-label"><input type="checkbox" value="ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰" onchange="filterCards()"> L</label>
                </div>
                
                <label>ATK / HP</label>
                <div class="range-box"><input type="number" id="q-atk-min" placeholder="0" oninput="filterCards()"><span>~</span><input type="number" id="q-atk-max" placeholder="âˆ" oninput="filterCards()"></div>
                <div class="range-box"><input type="number" id="q-hp-min" placeholder="0" oninput="filterCards()"><span>~</span><input type="number" id="q-hp-max" placeholder="âˆ" oninput="filterCards()"></div>
                
                <label>ä¸¦ã³æ›¿ãˆ</label>
                <div style="grid-column: span 2; display: flex; gap: 5px;">
                    <select id="q-sort-key" onchange="filterCards()" style="flex: 2;">
                        <option value="id">ID (ç™»éŒ²é †)</option>
                        <option value="name">åå‰ (ã‚ã„ã†ãˆãŠé †)</option>
                        <option value="costTotal">ã‚³ã‚¹ãƒˆ</option>
                        <option value="atk">ATK (æ”»æ’ƒåŠ›)</option>
                        <option value="hp">HP (ä½“åŠ›)</option>
                    </select>
                    <select id="q-sort-dir" onchange="filterCards()" style="flex: 1;">
                        <option value="1">æ˜‡é † (â–²)</option>
                        <option value="-1">é™é † (â–¼)</option>
                    </select>
                </div>
            </div>
            
            <div id="search-results"></div>
        </div>
        
        <div class="gutter" id="gutter-build"></div>
        
        <div class="right-pane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                <h3 style="margin:0;">Deck: <span id="total-count" style="color:var(--accent);">0</span>æš</h3>
                <button class="btn btn-accent" onclick="switchToMulligan()">ä¸€äººå›ã— â”</button>
            </div>
            <div id="deck-list"></div>
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button class="btn btn-blue" onclick="copyRecipe()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btn-red" onclick="if(confirm('ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){myDeck=[];renderDeck();}">Clear</button>
            </div>
        </div>
    </div>

    <div id="screen-mulligan" class="screen">
        <div class="left-pane" id="pane-l-mulligan">
            <button class="btn btn-blue" onclick="switchToBuilder()" style="margin-bottom:10px;">â† æ§‹ç¯‰ã¸æˆ»ã‚‹</button>
            <textarea id="manual-input" placeholder="ã‚«ãƒ¼ãƒ‰å x4..."></textarea>
            <div style="display: flex; gap: 5px; margin-bottom:10px;">
                <button class="btn btn-green" style="flex:1" onclick="applyManualList()">é©ç”¨</button>
                <button class="btn btn-blue" onclick="document.getElementById('recipe-upload').click()">èª­è¾¼</button>
                <input type="file" id="recipe-upload" accept=".txt" style="display:none;" onchange="handleRecipeUpload(event)">
            </div>
            <div class="filter-grid">
                <label>è¨­å®š</label>
                åˆæ‰‹æšæ•°: <input type="number" id="hand-size" value="7" min="1" max="10">
                <button class="btn btn-accent" style="grid-column:span 2; margin-top:10px;" onclick="initSim()">å±±æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦é–‹å§‹</button>
            </div>
        </div>
        <div class="gutter" id="gutter-mulligan"></div>

        <div class="right-pane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                <h3 style="margin:0;">Sim: å±±æœ­ <span id="sim-deck-count" style="color:var(--accent);">0</span>æš</h3>
                <button class="btn btn-green" onclick="drawOne()">ãƒ‰ãƒ­ãƒ¼</button>
            </div>
            <div id="play-area"></div>
        </div>
    </div>

    <div id="mobile-nav">
        <button class="nav-btn active" id="btn-search" onclick="showMobilePane('left')">ğŸ” æ¤œç´¢</button>
        <button class="nav-btn" id="btn-deck" onclick="showMobilePane('right')">ğŸƒ ãƒ‡ãƒƒã‚­<span id="mobile-deck-count" class="nav-badge">0</span></button>
    </div>

    <script>
        /* =========================================
           â˜…ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚¨ãƒªã‚¢ (ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¨­å®š)
           ========================================= */
        const CONFIG = {
            // --- ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«è¨­å®š ---
            maxCardsInDeck: 4,      // åŒåã‚«ãƒ¼ãƒ‰ã®æœ€å¤§æšæ•°
            defaultHandSize: 7,     // ä¸€äººå›ã—é–‹å§‹æ™‚ã®æ‰‹æœ­æšæ•°
            
            // --- CSVåˆ—ç•ªå·è¨­å®š (0ã‹ã‚‰æ•°ãˆã¦ä½•ç•ªç›®ã‹) ---
            // Excelç­‰ã§åˆ—ã‚’å¢—ã‚„ã—ãŸå ´åˆã¯ã“ã“ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„
            col: {
                name: 0,            // ã‚«ãƒ¼ãƒ‰å
                color: 1,           // è‰²
                rarity: 2,          // ãƒ¬ã‚¢ãƒªãƒ†ã‚£
                category: 3,        // åˆ†é¡ï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆ/ãƒã‚¸ãƒƒã‚¯ç­‰ï¼‰
                type: 4,            // ã‚¿ã‚¤ãƒ—ï¼ˆç¨®æ—ç­‰ï¼‰
                cost: 6,            // ã‚³ã‚¹ãƒˆ
                atk: 8,             // æ”»æ’ƒåŠ›
                hp: 9,              // ä½“åŠ›
                effect1: 11,        // åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆ1
                effect2: 12,        // åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆ2
                effect3: 13,        // åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆ3
                effect4: 14,        // åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆ4
                image: 16,          // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å
                reading: 17         // ã²ã‚‰ãŒãªèª­ã¿
            },

            // --- ç”»åƒãƒ‘ã‚¹è¨­å®š ---
            path: {
                cardImg: 'images/',         // ã‚«ãƒ¼ãƒ‰ç”»åƒã®ãƒ•ã‚©ãƒ«ãƒ€
                iconImg: 'images/icons/',   // ãƒ†ã‚­ã‚¹ãƒˆå†…ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ•ã‚©ãƒ«ãƒ€
                placeholder: 'https://via.placeholder.com/110x154?text=NoImg'
            },

            // --- ã‚·ã‚¹ãƒ†ãƒ ç”¨å®šæ•° (åŸºæœ¬å¤‰æ›´ä¸è¦) ---
            defaultCostMax: 999,
            defaultStatMax: 99999
        };

        /* =========================================
           ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚¸ãƒƒã‚¯
           ========================================= */
        let MASTER_DB = [], myDeck = [], simDeck = [], hoverTimer = null;
        const isMobile = () => window.innerWidth <= 768;

        window.addEventListener('DOMContentLoaded', () => {
            setupResizer('pane-l-build', 'gutter-build');
            setupResizer('pane-l-mulligan', 'gutter-mulligan');
            showMobilePane('left'); 
            
            // æ‰‹æœ­æšæ•°ã®åˆæœŸå€¤ã‚’CONFIGã‹ã‚‰åæ˜ 
            document.getElementById('hand-size').value = CONFIG.defaultHandSize;

            fetch('card_list.csv')
                .then(res => { if (!res.ok) throw new Error(); return res.text(); })
                .then(text => parseCSV(text))
                .catch(() => alert("CSVãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚"));
        });

        // CSVè§£æãƒ­ã‚¸ãƒƒã‚¯
        function parseCSV(txt) {
            const lines = txt.split(/\r?\n/);
            MASTER_DB = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim(); if(!line) continue;
                // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼ˆã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
                const cells = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (cells.length < 10) continue;

                const clean = (str) => {
                    let s = (str || "").trim();
                    if (s.startsWith('"') && s.endsWith('"')) s = s.slice(1, -1).replace(/""/g, '"');
                    return s;
                };

                let fName = clean(cells[CONFIG.col.image]);
                if (fName && !fName.includes(".")) fName += ".png";

                const name = clean(cells[CONFIG.col.name]);
                const cat = clean(cells[CONFIG.col.category]);
                const type = clean(cells[CONFIG.col.type]);
                const reading = clean(cells[CONFIG.col.reading]);
                
                // åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆã®çµåˆ
                const effects = [
                    cells[CONFIG.col.effect1], cells[CONFIG.col.effect2], 
                    cells[CONFIG.col.effect3], cells[CONFIG.col.effect4]
                ].map(t => clean(t)).filter(t => t && t !== "-" && t !== "â€").join("\n");

                // æ¤œç´¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆã®ç”Ÿæˆ
                const toHira = (s) => s.replace(/[\u30a1-\u30f6]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60));
                const rawText = name + reading + type + cat + effects;
                const searchBase = (rawText + toHira(rawText)).toLowerCase();

                MASTER_DB.push({
                    id: i, name: name, reading: reading, 
                    color: clean(cells[CONFIG.col.color]), 
                    rarity: clean(cells[CONFIG.col.rarity]), 
                    category: cat, type: type,
                    costTotal: parseInt(clean(cells[CONFIG.col.cost])) || 0,
                    atk: parseInt(clean(cells[CONFIG.col.atk])) || 0, 
                    hp: parseInt(clean(cells[CONFIG.col.hp])) || 0,
                    effect: effects, fileName: fName, searchText: searchBase 
                });
            }
            filterCards();
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
        function filterCards() {
            const getChecked = (id) => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(e => e.value);
            const getNum = (id, def) => {
                const v = document.getElementById(id).value;
                return v === "" ? def : parseInt(v);
            };

            const q = {
                text: document.getElementById('q-text').value.toLowerCase().trim(),
                cats: getChecked('grp-cat'), cols: getChecked('grp-col'), rares: getChecked('grp-rare'),
                cMin: getNum('q-cost-min', 0), cMax: getNum('q-cost-max', CONFIG.defaultCostMax),
                aMin: getNum('q-atk-min', 0), aMax: getNum('q-atk-max', CONFIG.defaultStatMax),
                hMin: getNum('q-hp-min', 0), hMax: getNum('q-hp-max', CONFIG.defaultStatMax)
            };

            let filtered = MASTER_DB.filter(c => {
                if (!c.searchText.includes(q.text)) return false;
                if (q.cats.length > 0 && !q.cats.some(cat => c.category.includes(cat))) return false;
                if (q.cols.length > 0 && !q.cols.some(col => c.color.includes(col))) return false;
                if (q.rares.length > 0 && !q.rares.some(r => c.rarity === r)) return false;
                if (c.costTotal < q.cMin || c.costTotal > q.cMax) return false;
                if (c.atk < q.aMin || c.atk > q.aMax) return false;
                if (c.hp < q.hMin || c.hp > q.hMax) return false;
                return true;
            });

            const sortKey = document.getElementById('q-sort-key').value;
            const sortDir = parseInt(document.getElementById('q-sort-dir').value);
            filtered.sort((a, b) => {
                if (sortKey === 'name') {
                    const valA = a.reading || a.name; const valB = b.reading || b.name;
                    return String(valA).localeCompare(String(valB), 'ja') * sortDir;
                }
                const valA = a[sortKey] || 0; const valB = b[sortKey] || 0;
                return (valA - valB) * sortDir;
            });
            renderResults(filtered);
        }

        // çµæœæç”»
        function renderResults(list) {
            const area = document.getElementById('search-results'); area.innerHTML = '';
            list.forEach(c => {
                const safeName = c.name.replace(/'/g, "\\'");
                const div = document.createElement('div');
                div.className = 'card-row';
                
                // ã‚¢ã‚¤ã‚³ãƒ³ç½®æ›å‡¦ç†
                let effectHtml = c.effect.replace(/ï¼ˆ/g, '(').replace(/ï¼‰/g, ')');
                effectHtml = effectHtml.replace(/\(([^)]{1,15})\)/g, (match, content) => {
                    return `<img src="${CONFIG.path.iconImg}${content.trim()}.png" class="inline-icon" onerror="this.style.display='none';this.insertAdjacentText('afterend','${match}')">`;
                });

                const statPart = (c.category.includes("ãƒ¦ãƒ‹ãƒƒãƒˆ") || c.atk > 0 || c.hp > 0) 
                    ? `<span class="stat-emphasis">${c.atk}/${c.hp}</span>` : "";

                div.innerHTML = `
                    <div class="img-box" onclick="!isMobile() && addToDeck('${safeName}')">
                        <img src="${CONFIG.path.cardImg}${c.fileName}" onerror="this.src='${CONFIG.path.placeholder}'">
                    </div>
                    <div class="card-info">
                        <div class="info-header">
                            <span class="card-name">${c.name}</span>
                            <span class="card-sub">${statPart}<span class="info-scroll-area">| ${c.category} | ${c.color} | ${c.type}</span></span>
                        </div>
                        ${c.effect ? `<div class="card-effect">${effectHtml}</div>` : ""}
                    </div>
                    <button class="btn btn-green btn-add" onclick="addToDeck('${safeName}')">+</button>
                `;
                enablePreview(div.querySelector('.img-box img'), `${CONFIG.path.cardImg}${c.fileName}`);
                area.appendChild(div);
            });
        }

        // ãƒ‡ãƒƒã‚­æ“ä½œ
        function addToDeck(name) {
            const master = MASTER_DB.find(d => d.name === name);
            const inDeck = myDeck.find(d => d.name === name);
            if (inDeck) { 
                if (inDeck.count >= CONFIG.maxCardsInDeck) return; 
                inDeck.count++; 
            } else { 
                myDeck.push({...master, count: 1}); 
            }
            myDeck.sort((a,b) => a.id - b.id); renderDeck();
        }

        function removeFromDeck(name) {
            const inDeck = myDeck.find(d => d.name === name);
            if (inDeck) { inDeck.count--; if (inDeck.count <= 0) myDeck = myDeck.filter(d => d.name !== name); }
            renderDeck();
        }

        function renderDeck() {
            const area = document.getElementById('deck-list'); area.innerHTML = '';
            myDeck.forEach(d => {
                const safeName = d.name.replace(/'/g, "\\'");
                const div = document.createElement('div'); div.className = 'deck-item';
                div.innerHTML = `
                    <div class="badge">${d.count}</div>
                    <img src="${CONFIG.path.cardImg}${d.fileName}" onerror="this.src='${CONFIG.path.placeholder}'" oncontextmenu="event.preventDefault(); removeFromDeck('${safeName}')">
                    <div class="deck-controls">
                        <button class="ctrl-btn minus" onclick="event.stopPropagation(); removeFromDeck('${safeName}')">ï¼</button>
                        <button class="ctrl-btn plus" onclick="event.stopPropagation(); addToDeck('${safeName}')">ï¼‹</button>
                    </div>
                `;
                enablePreview(div.querySelector('img'), `${CONFIG.path.cardImg}${d.fileName}`);
                area.appendChild(div);
            });
            const total = myDeck.reduce((acc, d) => acc + d.count, 0);
            document.getElementById('total-count').textContent = total;
            document.getElementById('mobile-deck-count').textContent = total;
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
        function enablePreview(el, src) {
            if (isMobile()) {
                el.onclick = (e) => {
                    const p = document.getElementById('hover-preview');
                    document.getElementById('preview-img').src = src;
                    // è¿½åŠ ï¼šã‚¹ãƒãƒ›ç‰ˆã§ã¯é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
                    document.getElementById('preview-close-btn').style.display = 'block';
                    p.style.display = 'flex';
                    e.stopPropagation();
                };
            } else {
                el.onmouseenter = (e) => {
                    hoverTimer = setTimeout(() => {
                        const p = document.getElementById('hover-preview');
                        document.getElementById('preview-img').src = src;
                        p.style.display = 'block';
                        updatePreviewPos(e);
                    }, 300);
                };
                el.onmousemove = updatePreviewPos;
                el.onmouseleave = () => { clearTimeout(hoverTimer); document.getElementById('hover-preview').style.display = 'none'; };
            }
        }
        
        function updatePreviewPos(e) {
            const p = document.getElementById('hover-preview');
            let x = e.clientX + 20, y = e.clientY + 20;
            if (x + 320 > window.innerWidth) x = e.clientX - 340;
            if (y + 448 > window.innerHeight) y = e.clientY - 468;
            p.style.left = Math.max(0, x) + 'px'; p.style.top = Math.max(0, y) + 'px';
        }

        function closePreviewMobile() { 
            document.getElementById('hover-preview').style.display = 'none'; 
            // è¿½åŠ ï¼šé–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«æˆ»ã™
            document.getElementById('preview-close-btn').style.display = 'none';
        }

        // UIãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function toggleFilters() {
            const area = document.getElementById('advanced-filters');
            const btn = document.getElementById('filter-toggle-btn');
            const isClosed = window.getComputedStyle(area).display === 'none';
            area.style.display = isClosed ? 'grid' : 'none';
            btn.textContent = isClosed ? 'â–² è©³ç´°æ¡ä»¶ã‚’é–‰ã˜ã‚‹' : 'â–¼ è©³ç´°æ¡ä»¶ã‚’æŒ‡å®šã™ã‚‹';
        }

        function setupResizer(leftId, gutterId) {
            const leftPane = document.getElementById(leftId);
            const gutter = document.getElementById(gutterId);
            let isDragging = false;
            gutter.addEventListener('mousedown', (e) => { isDragging = true; gutter.classList.add('dragging'); e.preventDefault(); });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                leftPane.style.width = Math.max(200, Math.min(e.clientX, window.innerWidth - 100)) + 'px';
            });
            document.addEventListener('mouseup', () => { isDragging = false; gutter.classList.remove('dragging'); });
        }

        function showMobilePane(side) {
            const activeScreen = document.querySelector('.screen.active');
            const left = activeScreen.querySelector('.left-pane'), right = activeScreen.querySelector('.right-pane');
            const btnS = document.getElementById('btn-search'), btnD = document.getElementById('btn-deck');
            if (side === 'left') {
                left.classList.add('active-pane'); right.classList.remove('active-pane');
                btnS.classList.add('active'); btnD.classList.remove('active');
            } else {
                left.classList.remove('active-pane'); right.classList.add('active-pane');
                btnS.classList.remove('active'); btnD.classList.add('active');
            }
        }

        // ä¸€äººå›ã—ãƒ­ã‚¸ãƒƒã‚¯
        function switchToMulligan() { 
            document.getElementById('screen-builder').classList.remove('active'); 
            document.getElementById('screen-mulligan').classList.add('active'); 
            document.getElementById('manual-input').value = myDeck.map(d => `${d.name} x${d.count}`).join("\n"); 
            showMobilePane('left'); 
        }
        function switchToBuilder() { 
            document.getElementById('screen-mulligan').classList.remove('active'); 
            document.getElementById('screen-builder').classList.add('active'); 
            showMobilePane('left'); 
        }
        
        function initSim() {
            simDeck = []; myDeck.forEach(c => { for(let i=0; i<c.count; i++) simDeck.push({...c}); });
            if (simDeck.length < 1) return alert("ãƒ‡ãƒƒã‚­ãŒç©ºã§ã™");
            for (let i = simDeck.length - 1; i > 0; i--) { 
                const j = Math.floor(Math.random() * (i + 1)); [simDeck[i], simDeck[j]] = [simDeck[j], simDeck[i]]; 
            }
            document.getElementById('play-area').innerHTML = '';
            const hSize = parseInt(document.getElementById('hand-size').value);
            for (let i = 0; i < hSize; i++) drawOne();
            updateSimCount();
            if (isMobile()) showMobilePane('right');
        }

        function drawOne() {
            if (simDeck.length === 0) return; 
            const card = simDeck.pop();
            const img = document.createElement('img');
            img.src = `${CONFIG.path.cardImg}${card.fileName}`; img.className = 'play-card';
            img.onerror = () => img.src = CONFIG.path.placeholder;
            enablePreview(img, img.src);
            img.onclick = () => img.remove();
            document.getElementById('play-area').appendChild(img);
            updateSimCount();
        }
        function updateSimCount() { document.getElementById('sim-deck-count').textContent = simDeck.length; }
        
        function copyRecipe() { 
            let txt = myDeck.map(d => `${d.name} x${d.count}`).join("\n"); 
            navigator.clipboard.writeText(txt).then(() => alert("ãƒ‡ãƒƒã‚­ãƒ¬ã‚·ãƒ”ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼")); 
        }

        function applyManualList() {
            const input = document.getElementById('manual-input').value; myDeck = [];
            input.split("\n").forEach(line => {
                let m = line.match(/^(.+?)\s*[xÃ—*]\s*(\d+)$/);
                let name = m ? m[1].trim() : line.trim(); 
                let count = m ? parseInt(m[2]) : 1;
                let master = MASTER_DB.find(card => card.name === name);
                if (master) myDeck.push({...master, count: Math.min(count, CONFIG.maxCardsInDeck)});
            });
            renderDeck();
        }

        function handleRecipeUpload(e) {
            const f = e.target.files[0]; const r = new FileReader();
            r.onload = (ev) => { document.getElementById('manual-input').value = ev.target.result; applyManualList(); };
            r.readAsText(f);
        }
    </script>
</body>
</html>
