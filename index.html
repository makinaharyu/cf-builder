<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>ãƒ‡ãƒƒã‚­ãƒ“ãƒ«ãƒ€ãƒ¼ | ã‚¯ãƒªãƒ•ãƒ­-Crystal Frontier-</title>
    <style>
        /* ==========================================================================
           â˜… ã‚µã‚¤ãƒˆè¨­å®šãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚¨ãƒªã‚¢
           ========================================================================== */
        :root {
            /* ---ã€1. ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºè¨­å®šã€‘--- */
            --card-w-pc: 110px;      /* PCè¡¨ç¤ºæ™‚ã®ã‚«ãƒ¼ãƒ‰å¹… */
            --card-h-pc: 154px;      /* PCè¡¨ç¤ºæ™‚ã®ã‚«ãƒ¼ãƒ‰é«˜ã• */
            
            --card-w-mob: 65px;      /* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã®ã‚«ãƒ¼ãƒ‰å¹… */
            --card-h-mob: 91px;     /* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã®ã‚«ãƒ¼ãƒ‰é«˜ã• */

            /* ---ã€2. é…è‰²è¨­å®šã€‘--- */
            --bg-main: #0d1117;      /* ç”»é¢å…¨ä½“ã®èƒŒæ™¯è‰² */
            --bg-panel: #161b22;     /* ãƒ‘ãƒãƒ«èƒŒæ™¯è‰² */
            --text-main: #c9d1d9;    /* ãƒ¡ã‚¤ãƒ³æ–‡å­—è‰² */
            --text-sub: #8b949e;     /* è£œè¶³æ–‡å­—è‰² */
            --border-col: #30363d;   /* æ ç·šã®è‰² */

            /* ---ã€3. ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ãƒ»ãƒœã‚¿ãƒ³è‰²ã€‘--- */
            --accent: #f1c40f;       /* å¼·èª¿è‰² */
            --col-blue: #1f6feb;     /* é’ãƒœã‚¿ãƒ³ */
            --col-green: #238636;    /* ç·‘ãƒœã‚¿ãƒ³ */
            --col-red: #f85149;      /* èµ¤ãƒœã‚¿ãƒ³ */
            
            --font-base: "Helvetica Neue", Arial, sans-serif;
        }

        /* å…¨ä½“è¨­å®š */
        body { 
            font-family: var(--font-base); 
            background: var(--bg-main); color: var(--text-main); 
            margin: 0; padding: 0; overflow: hidden; font-size: 13px;
            touch-action: manipulation; width: 100%; height: 100dvh;
        }
        
        :root { --card-w: var(--card-w-pc); --card-h: var(--card-h-pc); }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .screen { display: none; height: 100dvh; width: 100%; flex-direction: row; }
        .active { display: flex; }
        
        /* å·¦ãƒ‘ãƒãƒ« */
        .left-pane { 
            width: 450px; min-width: 250px; max-width: 80vw;
            border-right: none; padding: 10px; display: flex; 
            flex-direction: column; box-sizing: border-box; flex-shrink: 0; 
            background: var(--bg-panel);
        }

        /* ä»•åˆ‡ã‚Šç·š */
        .gutter {
            width: 8px; background: #21262d; cursor: col-resize;
            border-left: 1px solid var(--border-col); border-right: 1px solid var(--border-col);
            transition: background 0.2s; flex-shrink: 0; z-index: 100;
            display: flex; align-items: center; justify-content: center;
        }
        .gutter:hover, .gutter.dragging { background: var(--accent); }
        .gutter::after { content: "||"; color: #555; font-size: 9px; letter-spacing: -1px; }

        /* å³ãƒ‘ãƒãƒ« */
        .right-pane { 
            flex-grow: 1; min-width: 0; padding: 10px; display: flex; 
            flex-direction: column; box-sizing: border-box; background: var(--bg-main); 
        }
        
        /* æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼éƒ¨åˆ† */
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 8px; background: var(--bg-panel); padding: 8px; border-radius: 6px; border: 1px solid var(--border-col); }
        .filter-grid label { grid-column: span 2; font-size: 10px; color: var(--accent); margin-top: 2px; font-weight: bold; }
        input, select, textarea { background: var(--bg-main); color: #fff; border: 1px solid var(--border-col); padding: 4px 8px; border-radius: 4px; font-size: 12px; height: 26px; box-sizing: border-box; }
        textarea { width: 100%; height: 80px; resize: none; margin-bottom: 10px; }
        .range-box { display: flex; align-items: center; gap: 3px; }
        .range-box input { width: 100%; }

        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¨­å®š */
        .check-group { display: flex; flex-wrap: wrap; gap: 4px; grid-column: span 2; margin-bottom: 4px; }
        .check-label {
            display: inline-block; cursor: pointer; font-size: 11px;
            background: #21262d; border: 1px solid var(--border-col);
            padding: 3px 8px; border-radius: 4px; color: var(--text-main); 
            user-select: none; transition: 0.2s; touch-action: manipulation;
        }
        .check-label input { display: none; } 
        .check-label:has(input:checked) { background: var(--col-blue); color: #fff; border-color: var(--col-blue); }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        #search-results { flex-grow: 1; overflow-y: auto; overflow-x: hidden; background: #000; border: 1px solid var(--border-col); }
        #deck-list { flex-grow: 1; overflow-y: auto; overflow-x: hidden; background: #000; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, var(--card-w)); gap: 12px; align-content: start; }
        #play-area { flex-grow: 1; overflow-y: auto; overflow-x: hidden; background: #0a2012; border-radius: 8px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; padding: 20px; }

        /* ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .card-row { display: flex; padding: 6px; border-bottom: 1px solid var(--border-col); gap: 8px; background: var(--bg-panel); align-items: flex-start; }
        .card-row:hover { background: #21262d; }
        
        .img-box { width: 50px; height: 70px; background: #222; border: 1px solid #444; flex-shrink: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; touch-action: manipulation; }
        .img-box img { width: 100%; height: 100%; object-fit: contain; }
        
        .card-info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; gap: 2px; }
        .info-header { display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; margin-bottom: 2px; min-width: 0; }
        
        /* ã‚«ãƒ¼ãƒ‰åã®ãƒªãƒ³ã‚¯é¢¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .card-name { 
            font-weight: bold; color: #fff; font-size: 14px; margin-bottom: 2px; 
            width: 100%; overflow-x: auto; white-space: nowrap; 
            scrollbar-width: none; -ms-overflow-style: none;
            cursor: pointer;
            transition: color 0.2s;
            text-decoration-color: var(--col-blue);
        }
        .card-name:hover {
            color: var(--col-blue);
            text-decoration: underline;
        }
        .card-name::-webkit-scrollbar { display: none; }
        
        .card-sub { font-size: 11px; color: var(--text-sub); display: flex; align-items: center; width: 100%; overflow: hidden; }
        .stat-emphasis { font-family: "Impact", "Arial Black", sans-serif; font-size: 15px; color: #fff; letter-spacing: 0.5px; flex-shrink: 0; }

        .info-scroll-area { flex-grow: 1; overflow-x: auto; white-space: nowrap; scrollbar-width: none; -ms-overflow-style: none; margin-left: 4px; }
        .info-scroll-area::-webkit-scrollbar { display: none; }

        .card-effect { font-size: 11px; color: #ccc; line-height: 1.4; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 4px; max-height: 48px; overflow-y: auto; white-space: pre-wrap; border: 1px solid var(--border-col); }
        .card-effect::-webkit-scrollbar { width: 4px; }
        .card-effect::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }

        .inline-icon { height: 1.1em; width: auto; vertical-align: text-bottom; margin: 0 1px; display: inline-block; }
        
        .btn-add { height: 100%; align-self: center; touch-action: manipulation; flex-shrink: 0; }

        .deck-item { position: relative; width: var(--card-w); height: var(--card-h); cursor: pointer; }
        .deck-item img { width: 100%; height: 100%; border: 1px solid #fff; border-radius: 4px; object-fit: cover; transition: 0.1s; touch-action: manipulation; }
        .badge { position: absolute; top: -6px; right: -6px; background: var(--col-red); color: #fff; width: 22px; height: 22px; line-height: 22px; border-radius: 50%; font-weight: bold; text-align: center; border: 2px solid #fff; z-index: 10; font-size: 11px; pointer-events: none; }
        
        .deck-controls { position: absolute; bottom: 0; left: 0; width: 100%; height: 30px; z-index: 20; border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; overflow: hidden; display: flex; }
        .ctrl-btn { width: 50%; height: 100%; border: none; color: #fff; font-weight: bold; font-size: 16px; cursor: pointer; padding: 0; margin: 0; touch-action: manipulation; }
        .ctrl-btn.minus { background: rgba(200, 50, 50, 0.8); }
        .ctrl-btn.plus { background: rgba(50, 200, 50, 0.8); }

        .play-card { width: 120px; height: 168px; border: 2px solid #fff; border-radius: 6px; background: #000; animation: drawAnim 0.3s ease-out; cursor: help; touch-action: manipulation; }
        
        #hover-preview { position: fixed; z-index: 9999; pointer-events: none; display: none; background: #000; border: 3px solid var(--accent); border-radius: 10px; box-shadow: 0 0 30px rgba(0,0,0,0.9); width: 320px; height: 448px; overflow: hidden; transition: opacity 0.3s; }
        #hover-preview img { width: 100%; height: 100%; object-fit: contain; }
        #preview-close-btn { display: none; position: absolute; top: 5px; left: 5px; z-index: 10000; width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.8); color: #000; font-weight: bold; font-size: 20px; border: 2px solid #000; cursor: pointer; align-items: center; justify-content: center; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: #fff; font-size: 12px; touch-action: manipulation; }
        .btn-green { background: var(--col-green); } .btn-blue { background: var(--col-blue); } .btn-accent { background: var(--accent); color: #000; } .btn-red { background: var(--col-red); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        @keyframes drawAnim { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        #mobile-nav { display: none; }
        #filter-toggle-btn { display: none; }
        #advanced-filters { display: grid; }

        @media (max-width: 768px) {
            .pc-only-text { display: none !important; }
            :root { --card-w: var(--card-w-mob); --card-h: var(--card-h-mob); }
            .play-card { width: var(--card-w-mob); height: var(--card-h-mob); }
            .screen { flex-direction: column; height: calc(100dvh - 50px); }
            .left-pane, .right-pane { width: 100% !important; max-width: 100% !important; height: 100%; display: none; padding: 15px 5px 5px 5px; padding-top: calc(10px + env(safe-area-inset-top, 0px)); box-sizing: border-box; }
            .left-pane.active-pane, .right-pane.active-pane { display: flex; }
            .gutter { display: none !important; }

            #advanced-filters { display: none; border-top: none; margin-top: -5px; }
            #filter-toggle-btn { display: block; width: 100%; padding: 8px; margin-bottom: 5px; background: #21262d; border: 1px solid var(--border-col); color: var(--text-sub); cursor: pointer; font-size: 12px; font-weight: bold; border-radius: 4px; }

            .btn-add { width: 40px; font-size: 24px; align-self: stretch; display: flex; align-items: center; justify-content: center; margin-left: 2px; flex-shrink: 0; }

            #hover-preview { display: none; width: 100vw !important; height: 100dvh !important; top: 0 !important; left: 0 !important; border: none; border-radius: 0; transform: none; pointer-events: auto !important; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 9999; }
            
            #mobile-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; background: var(--bg-panel); border-top: 1px solid var(--border-col); z-index: 2000; padding-bottom: env(safe-area-inset-bottom, 0px); }
            .nav-btn { flex: 1; border: none; background: none; color: var(--text-sub); font-weight: bold; cursor: pointer; border-right: 1px solid var(--border-col); font-size: 13px; touch-action: manipulation; display: flex; align-items: center; justify-content: center; text-align: center; transition: all 0.2s ease; }
            .nav-btn.active { background: var(--col-blue); color: #fff; font-size: 15px; }
            .nav-badge { margin-left: 6px; min-width: 18px; height: 18px; background: #fff; color: #000; border-radius: 99px; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; padding: 0 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 2001; }
        }
    </style>
</head>
<body>
    <div id="hover-preview" onclick="closePreviewMobile()">
        <img id="preview-img" src="" onclick="event.stopPropagation()"> <div id="preview-close-btn" onclick="closePreviewMobile()">Ã—</div>
    </div>
    
    <div id="file-overlay" class="overlay" style="display: none;">
        <h2 style="color:var(--accent);">Crystal Frontier System</h2>
        <input type="file" id="csv-file" accept=".csv" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-green" onclick="loadFile('UTF-8')">UTF-8(æ¨å¥¨)</button>
            <button class="btn btn-blue" onclick="loadFile('Shift-JIS')">Shift-JIS(Excelç”¨)</button>
        </div>
    </div>

    <div id="screen-builder" class="screen active">
        <div class="left-pane" id="pane-l-build">
            <div class="filter-grid" style="margin-bottom: 5px; grid-template-columns: 1fr;">
                <input type="text" id="q-text" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»èª­ã¿(ã²ã‚‰ãŒãª)ã‚’å…¥åŠ›..." oninput="filterCards()" style="width:100%;">
            </div>

            <button id="filter-toggle-btn" onclick="toggleFilters()">â–¼ è©³ç´°æ¡ä»¶ã‚’æŒ‡å®šã™ã‚‹</button>

            <div class="filter-grid" id="advanced-filters">
                <label>åˆ†é¡ (è¤‡æ•°é¸æŠå¯)</label>
                <div class="check-group" id="grp-cat">
                    <label class="check-label"><input type="checkbox" value="ãƒ¦ãƒ‹ãƒƒãƒˆ" onchange="filterCards()"> ãƒ¦ãƒ‹ãƒƒãƒˆ</label>
                    <label class="check-label"><input type="checkbox" value="ãƒã‚¸ãƒƒã‚¯" onchange="filterCards()"> ãƒã‚¸ãƒƒã‚¯</label>
                    <label class="check-label"><input type="checkbox" value="ãƒ•ãƒ©ãƒƒã‚·ãƒ¥" onchange="filterCards()"> ãƒ•ãƒ©ãƒƒã‚·ãƒ¥</label>
                    <label class="check-label"><input type="checkbox" value="ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ" onchange="filterCards()"> ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</label>
                    <label class="check-label"><input type="checkbox" value="ã‚ªãƒ«ã‚¬ãƒãƒ³" onchange="filterCards()"> ã‚ªãƒ«ã‚¬ãƒãƒ³</label>
                    <label class="check-label"><input type="checkbox" id="chk-token" onchange="filterCards()"> ãƒˆãƒ¼ã‚¯ãƒ³</label>
                </div>

                <label>è‰² (è¤‡æ•°é¸æŠå¯)</label>
                <div class="check-group" id="grp-col">
                    <label class="check-label"><input type="checkbox" value="èµ¤" onchange="filterCards()"> èµ¤</label>
                    <label class="check-label"><input type="checkbox" value="ç·‘" onchange="filterCards()"> ç·‘</label>
                    <label class="check-label"><input type="checkbox" value="é’" onchange="filterCards()"> é’</label>
                    <label class="check-label"><input type="checkbox" value="ç™½" onchange="filterCards()"> ç™½</label>
                    <label class="check-label"><input type="checkbox" value="é»’" onchange="filterCards()"> é»’</label>
                    <label class="check-label"><input type="checkbox" value="ç„¡" onchange="filterCards()"> ç„¡</label>
                    <label class="check-label"><input type="checkbox" value="å¤š" onchange="filterCards()"> å¤š</label>
                </div>

                <label>ã‚³ã‚¹ãƒˆ</label>
                <div class="range-box">
                    <input type="number" id="q-cost-min" placeholder="0" oninput="filterCards()">
                    <span>~</span>
                    <input type="number" id="q-cost-max" placeholder="âˆ" oninput="filterCards()">
                </div>
                
                <label>ãƒ¬ã‚¢ãƒªãƒ†ã‚£ (è¤‡æ•°é¸æŠå¯)</label>
                <div class="check-group" id="grp-rare">
                    <label class="check-label"><input type="checkbox" value="ã‚³ãƒ¢ãƒ³" onchange="filterCards()"> C</label>
                    <label class="check-label"><input type="checkbox" value="ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³" onchange="filterCards()"> UC</label>
                    <label class="check-label"><input type="checkbox" value="ãƒ¬ã‚¢" onchange="filterCards()"> R</label>
                    <label class="check-label"><input type="checkbox" value="ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰" onchange="filterCards()"> L</label>
                </div>
                
                <label>ATK / HP</label>
                <div class="range-box"><input type="number" id="q-atk-min" placeholder="0" oninput="filterCards()"><span>~</span><input type="number" id="q-atk-max" placeholder="âˆ" oninput="filterCards()"></div>
                <div class="range-box"><input type="number" id="q-hp-min" placeholder="0" oninput="filterCards()"><span>~</span><input type="number" id="q-hp-max" placeholder="âˆ" oninput="filterCards()"></div>
                
                <label>ä¸¦ã³æ›¿ãˆ</label>
                <div style="grid-column: span 2; display: flex; gap: 5px;">
                    <select id="q-sort-key" onchange="filterCards()" style="flex: 2;">
                        <option value="id">ID (ç™»éŒ²é †)</option>
                        <option value="name">åå‰ (ã‚ã„ã†ãˆãŠé †)</option>
                        <option value="costTotal">ã‚³ã‚¹ãƒˆ</option>
                        <option value="atk">ATK (æ”»æ’ƒåŠ›)</option>
                        <option value="hp">HP (ä½“åŠ›)</option>
                    </select>
                    <select id="q-sort-dir" onchange="filterCards()" style="flex: 1;">
                        <option value="1">æ˜‡é † (â–²)</option>
                        <option value="-1">é™é † (â–¼)</option>
                    </select>
                </div>
            </div>
            
            <div id="search-results"></div>
        </div>
        <div class="gutter" id="gutter-build"></div>
        
        <div class="right-pane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                <h3 style="margin:0;">Deck: <span id="total-count" style="color:var(--accent);">0</span>æš</h3>
                <div class="pc-only-text" style="font-size:10px; color:#aaa;">(ç”»åƒã‚¯ãƒªãƒƒã‚¯:è¿½åŠ  / å³ã‚¯ãƒªãƒƒã‚¯:å‰Šé™¤)</div>
                <button class="btn btn-accent" onclick="switchToMulligan()">ä¸€äººå›ã— â”</button>
            </div>
            <div id="deck-list"></div>
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button class="btn btn-blue" onclick="copyRecipe()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btn-red" onclick="if(confirm('Reset?')){myDeck=[];renderDeck();}">Clear</button>
            </div>
        </div>
    </div>

    <div id="screen-mulligan" class="screen">
        <div class="left-pane" id="pane-l-mulligan">
            <button class="btn btn-blue" onclick="switchToBuilder()" style="margin-bottom:10px;">â† æ§‹ç¯‰ã¸æˆ»ã‚‹</button>
            <textarea id="manual-input" placeholder="Name x4..."></textarea>
            <div style="display: flex; gap: 5px; margin-bottom:10px;">
                <button class="btn btn-green" style="flex:1" onclick="applyManualList()">é©ç”¨</button>
                <button class="btn btn-blue" onclick="document.getElementById('recipe-upload').click()">èª­è¾¼</button>
                <input type="file" id="recipe-upload" accept=".txt" style="display:none;" onchange="handleRecipeUpload(event)">
            </div>
            <div class="filter-grid">
                <label>è¨­å®š</label>
                åˆæ‰‹æšæ•°: <input type="number" id="hand-size" value="7" min="5" max="10">
                <button class="btn btn-accent" style="grid-column:span 2; margin-top:10px;" onclick="initSim()">å±±æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦é–‹å§‹</button>
            </div>
        </div>
        <div class="gutter" id="gutter-mulligan"></div>

        <div class="right-pane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                <h3 style="margin:0;">Mulligan: å±±æœ­ <span id="sim-deck-count" style="color:var(--accent);">0</span>æš</h3>
                <button class="btn btn-green" onclick="drawOne()">ãƒ‰ãƒ­ãƒ¼</button>
            </div>
            <div id="play-area"></div>
        </div>
    </div>

    <div id="mobile-nav">
        <button class="nav-btn active" id="btn-search" onclick="showMobilePane('left')">
            <span id="nav-text-l">ğŸ” æ¤œç´¢</span>
        </button>
        <button class="nav-btn" id="btn-deck" onclick="showMobilePane('right')">
            <span id="nav-text-r">ğŸƒ ãƒ‡ãƒƒã‚­</span>
            <span id="nav-badge" class="nav-badge" style="display:none;">0</span>
        </button>
    </div>

    <script>
        const CONFIG = {
            maxCardsInDeck: 4,
            defaultHandSize: 7,
            defaultCostMax: 999,
            defaultStatMax: 99999
        };

        let MASTER_DB = [], myDeck = [], simDeck = [], hoverTimer = null;
        const isMobile = () => window.innerWidth <= 768;

        window.addEventListener('DOMContentLoaded', () => {
            setupResizer('pane-l-build', 'gutter-build');
            setupResizer('pane-l-mulligan', 'gutter-mulligan');
            updateMobileNavLabels('builder');
            showMobilePane('left'); 

            fetch('card_list.csv')
                .then(response => {
                    if (!response.ok) throw new Error("CSVãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    return response.text();
                })
                .then(text => { parseCSV(text); })
                .catch(error => {
                    console.error('Error:', error);
                    alert("ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                });
        });

        // è©³ç´°ãƒšãƒ¼ã‚¸ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãé–¢æ•°
        function openCardDetail(name) {
            const url = `detail.html?name=${encodeURIComponent(name)}`;
            window.open(url, '_blank');
        }

        function updateMobileNavLabels(mode) {
            const txtL = document.getElementById('nav-text-l');
            const txtR = document.getElementById('nav-text-r');
            if (!txtL || !txtR) return;
            if (mode === 'builder') { txtL.textContent = 'ğŸ” æ¤œç´¢ãƒ»æ¡ä»¶'; txtR.textContent = 'ğŸƒ æ§‹ç¯‰ãƒ»ãƒªã‚¹ãƒˆ'; } 
            else if (mode === 'mulligan') { txtL.textContent = 'âš™ è¨­å®šãƒ»å…¥åŠ›'; txtR.textContent = 'â–¶ è©¦è¡Œã‚¨ãƒªã‚¢'; }
        }

        function showMobilePane(side) {
            const activeScreen = document.querySelector('.screen.active');
            if (!activeScreen) return;
            const left = activeScreen.querySelector('.left-pane');
            const right = activeScreen.querySelector('.right-pane');
            const btnSearch = document.getElementById('btn-search');
            const btnDeck = document.getElementById('btn-deck');
            
            if (side === 'left') {
                left.classList.add('active-pane'); right.classList.remove('active-pane');
                btnSearch.classList.add('active'); btnDeck.classList.remove('active');
            } else {
                left.classList.remove('active-pane'); right.classList.add('active-pane');
                btnSearch.classList.remove('active'); btnDeck.classList.add('active');
            }
        }

        function toggleFilters() {
            const area = document.getElementById('advanced-filters');
            const btn = document.getElementById('filter-toggle-btn');
            const isClosed = window.getComputedStyle(area).display === 'none';
            if (isClosed) {
                area.style.display = 'grid';
                btn.textContent = 'â–² è©³ç´°æ¡ä»¶ã‚’é–‰ã˜ã‚‹';
                btn.style.background = '#30363d'; btn.style.color = '#fff';
            } else {
                area.style.display = 'none';
                btn.textContent = 'â–¼ è©³ç´°æ¡ä»¶ã‚’æŒ‡å®šã™ã‚‹';
                btn.style.background = '#21262d'; btn.style.color = '#8b949e';
            }
        }

        function setupResizer(leftId, gutterId) {
            const leftPane = document.getElementById(leftId);
            const gutter = document.getElementById(gutterId);
            let isDragging = false;
            gutter.addEventListener('mousedown', (e) => {
                isDragging = true; gutter.classList.add('dragging');
                document.body.style.cursor = 'col-resize'; e.preventDefault();
            });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                let newWidth = e.clientX;
                if (newWidth < 200) newWidth = 200;
                if (newWidth > window.innerWidth - 100) newWidth = window.innerWidth - 100;
                leftPane.style.width = newWidth + 'px';
            });
            document.addEventListener('mouseup', () => {
                if (isDragging) { isDragging = false; gutter.classList.remove('dragging'); document.body.style.cursor = 'default'; }
            });
        }

        function closePreviewMobile() {
            const p = document.getElementById('hover-preview');
            const btn = document.getElementById('preview-close-btn');
            p.style.display = 'none'; btn.style.display = 'none';
        }

        function enablePreview(el, src) {
            if (isMobile()) {
                el.onclick = (e) => {
                    const p = document.getElementById('hover-preview');
                    const img = document.getElementById('preview-img');
                    const btn = document.getElementById('preview-close-btn');
                    img.src = src; p.style.display = 'flex'; p.style.opacity = '1'; btn.style.display = 'flex';
                    e.stopPropagation();
                };
            } else {
                el.onmouseenter = (e) => {
                    hoverTimer = setTimeout(() => {
                        const p = document.getElementById('hover-preview');
                        document.getElementById('preview-img').src = src;
                        p.style.display = 'block'; p.style.opacity = '1'; updatePreviewPos(e);
                    }, 300);
                };
                el.onmousemove = (e) => updatePreviewPos(e);
                el.onmouseleave = () => { clearTimeout(hoverTimer); document.getElementById('hover-preview').style.display = 'none'; };
            }
        }
        
        function updatePreviewPos(e) {
            if (isMobile()) return;
            const p = document.getElementById('hover-preview');
            const offset = 20; const pW = 320, pH = 448;
            let x = e.clientX + offset, y = e.clientY + offset;
            if (x + pW > window.innerWidth) x = e.clientX - pW - offset;
            if (y + pH > window.innerHeight) y = e.clientY - pH - offset;
            p.style.left = Math.max(0, x) + 'px'; p.style.top = Math.max(0, y) + 'px';
        }

        function loadFile(enc) { const f=document.getElementById('csv-file').files[0]; if(!f)return; const r=new FileReader(); r.onload=(e)=>{ parseCSV(e.target.result); document.getElementById('file-overlay').style.display='none'; }; r.readAsText(f,enc); }
        
        function parseCSV(txt) {
            const lines = txt.split(/\r?\n/);
            MASTER_DB = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim(); if(!line) continue;
                const cells = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (cells.length < 16) continue;
                
                const clean = (str) => {
                    let s = (str || "").trim();
                    if (s.startsWith('"') && s.endsWith('"')) s = s.slice(1, -1).replace(/""/g, '"');
                    return s;
                };
                let fName = clean(cells[16]);
                if (fName && !fName.includes(".")) fName += ".png";
                const name = clean(cells[0]);
                const category = clean(cells[3]);
                const type = clean(cells[4]);
                const reading = clean(cells[17]); 
                const rawEffects = [cells[11], cells[12], cells[13], cells[14]];
                const effect = rawEffects.map(t => clean(t)).filter(t => t !== "" && t !== "-" && t !== "â€").join("\n");
                const toHira = (str) => str.replace(/[\u30a1-\u30f6]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60));
                const rawText = name + reading + type + category + effect;
                const searchText = (rawText + toHira(rawText)).toLowerCase();
                
                const isToken = category.includes("ãƒˆãƒ¼ã‚¯ãƒ³") || type.includes("ãƒˆãƒ¼ã‚¯ãƒ³");

                MASTER_DB.push({
                    id: i, name: name, reading: reading, 
                    color: clean(cells[1]), rarity: clean(cells[2]), category: category, type: type,
                    costTotal: parseInt(clean(cells[6])) || 0,
                    atk: parseInt(clean(cells[8])) || 0, hp: parseInt(clean(cells[9])) || 0,
                    effect: effect, fileName: fName, searchText: searchText,
                    isToken: isToken 
                });
            }
            filterCards();
        }

        function filterCards() {
            // ã‚«ãƒ†ã‚´ãƒªã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ä»¥å¤–ï¼‰
            const getChecked = (id) => Array.from(document.querySelectorAll(`#${id} input:checked:not(#chk-token)`)).map(e => e.value);
            const getNum = (id, def) => { const v = document.getElementById(id).value; return v === "" ? def : parseInt(v); };
            
            // ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹
            const showToken = document.getElementById('chk-token').checked;

            const rawText = document.getElementById('q-text').value.toLowerCase().trim();
            const keywords = rawText ? rawText.split(/[\sã€€]+/) : []; 

            const q = {
                keywords: keywords,
                cats: getChecked('grp-cat'), cols: getChecked('grp-col'), rares: getChecked('grp-rare'),
                cMin: getNum('q-cost-min', 0), cMax: getNum('q-cost-max', CONFIG.defaultCostMax),
                aMin: getNum('q-atk-min', 0), aMax: getNum('q-atk-max', CONFIG.defaultStatMax),
                hMin: getNum('q-hp-min', 0), hMax: getNum('q-hp-max', CONFIG.defaultStatMax)
            };

            let filtered = MASTER_DB.filter(c => {
                // 1. åŸºæœ¬çš„ãªãƒˆãƒ¼ã‚¯ãƒ³éè¡¨ç¤ºãƒ«ãƒ¼ãƒ«
                if (c.isToken && !showToken) return false;

                // 2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‹•ä½œ
                if (q.cats.length > 0 || showToken) {
                    let matchCat = false;
                    
                    if (q.cats.some(cat => c.category.includes(cat))) {
                        matchCat = true;
                    }
                    if (showToken && c.isToken) {
                        matchCat = true;
                    }
                    if (!matchCat) return false;
                }
                
                if (q.keywords.length > 0 && !q.keywords.every(key => c.searchText.includes(key))) return false;
                if (q.cols.length > 0 && !q.cols.some(col => c.color.includes(col))) return false;
                if (q.rares.length > 0 && !q.rares.some(r => c.rarity === r)) return false;
                if (c.costTotal < q.cMin || c.costTotal > q.cMax) return false;
                if (c.atk < q.aMin || c.atk > q.aMax) return false;
                if (c.hp < q.hMin || c.hp > q.hMax) return false;
                return true;
            });

            const sortKey = document.getElementById('q-sort-key').value;
            const sortDir = parseInt(document.getElementById('q-sort-dir').value);
            
            filtered.sort((a, b) => {
                let valA, valB;
                
                if (sortKey === 'name') {
                    valA = a.reading || a.name; 
                    valB = b.reading || b.name;
                    return String(valA).localeCompare(String(valB), 'ja') * sortDir;
                } else if (sortKey === 'id') {
                    valA = a.id; valB = b.id;
                } else {
                    valA = a[sortKey] || 0; 
                    valB = b[sortKey] || 0;
                }
                
                if (valA !== valB) {
                    return (valA - valB) * sortDir;
                }
                return a.id - b.id;
            });

            renderResults(filtered);
        }

        function formatEffect(text) {
            if (!text) return "";
            let normalized = text.replace(/ï¼ˆ/g, '(').replace(/ï¼‰/g, ')');
            return normalized.replace(/\(([^)]{1,15})\)/g, (match, content) => {
                const cleanContent = content.trim();
                const safeMatch = match.replace(/"/g, '&quot;');
                const safeContent = cleanContent.replace(/'/g, "\\'");
                return `<img src="images/icons/${cleanContent}.png" class="inline-icon" alt="${safeMatch}" onerror="this.style.display='none';this.insertAdjacentText('afterend','${safeMatch}')">`;
            });
        }

        function renderResults(list) {
            const area = document.getElementById('search-results'); 
            area.innerHTML = '';
            const mobile = isMobile();
            
            list.forEach(c => {
                const safeName = c.name.replace(/'/g, "\\'");
                const safeNameAttr = safeName.replace(/"/g, "&quot;");
                
                const div = document.createElement('div');
                div.className = 'card-row';
                
                const effectHtml = formatEffect(c.effect);
                const effectPart = effectHtml ? `<div class="card-effect">${effectHtml}</div>` : ""; 
                
                let infoParts = [];
                let hasStat = false;
                if ((c.category && c.category.includes("ãƒ¦ãƒ‹ãƒƒãƒˆ")) || c.atk > 0 || c.hp > 0) hasStat = true;
                if (c.category) infoParts.push(c.category);
                if (c.color) infoParts.push(c.color);
                if (c.type && c.type !== "-" && c.type !== "â€") infoParts.push(c.type);
                
                let subInfoHtml = "";
                if (hasStat) {
                    subInfoHtml = `<span class="stat-emphasis">${c.atk}/${c.hp}</span><span class="info-scroll-area">| ${infoParts.join(" | ")}</span>`;
                } else {
                    subInfoHtml = `<span class="info-scroll-area">${infoParts.join(" | ")}</span>`;
                }

                // â˜…ä¿®æ­£: ãƒˆãƒ¼ã‚¯ãƒ³ã®å ´åˆã¯ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§ã®ãƒ‡ãƒƒã‚­è¿½åŠ ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ï¼ˆç©ºæ–‡å­—ã«ã™ã‚‹ï¼‰
                const imgClickAction = (mobile || c.isToken) ? "" : `onclick="addToDeck('${safeNameAttr}')"`;
                
                // â˜…ä¿®æ­£: ãƒˆãƒ¼ã‚¯ãƒ³ã®å ´åˆã¯è¿½åŠ ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ãªã„
                const addBtn = c.isToken ? "" : `<button class="btn btn-green btn-add" onclick="addToDeck('${safeNameAttr}')">+</button>`;
                
                div.innerHTML = `
                    <div class="img-box" ${imgClickAction}>
                        <img src="images/${c.fileName}" onerror="this.src='https://via.placeholder.com/50x70?text=NoImg'">
                    </div>
                    <div class="card-info">
                        <div class="info-header">
                            <span class="card-name" onclick="openCardDetail('${safeNameAttr}')" title="è©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ã">${c.name}</span>
                            <span class="card-sub">${subInfoHtml}</span>
                        </div>
                        ${effectPart}
                    </div>
                    ${addBtn}
                `;
                enablePreview(div.querySelector('.img-box img'), `images/${c.fileName}`);
                area.appendChild(div);
            });
        }

        function addToDeck(name) {
            const master = MASTER_DB.find(d => d.name === name);
            if (!master) return;
            // â˜…ä¿®æ­£: ä¸‡ãŒä¸€ãƒˆãƒ¼ã‚¯ãƒ³ãŒå‘¼ã°ã‚Œã¦ã‚‚ãƒ‡ãƒƒã‚­ã«å…¥ã‚Œãªã„
            if (master.isToken) return;

            const inDeck = myDeck.find(d => d.name === name);
            if (inDeck) { if (inDeck.count >= CONFIG.maxCardsInDeck) return; inDeck.count++; } 
            else { myDeck.push({...master, count: 1}); }
            myDeck.sort((a,b) => a.id - b.id); renderDeck();
        }

        function renderDeck() {
            const area = document.getElementById('deck-list'); area.innerHTML = '';
            const mobile = isMobile();
            let totalCards = 0;
            myDeck.forEach(d => {
                totalCards += d.count;
                const safeName = d.name.replace(/'/g, "\\'");
                const safeNameAttr = safeName.replace(/"/g, "&quot;");
                
                const div = document.createElement('div'); div.className = 'deck-item';
                // ãƒ‡ãƒƒã‚­å†…ã®ãƒˆãƒ¼ã‚¯ãƒ³å¯¾å¿œï¼ˆé€šå¸¸ã‚ã‚Šãˆãªã„ãŒå¿µã®ãŸã‚ï¼‰
                const imgAction = (mobile || d.isToken) ? "" : `onclick="addToDeck('${safeNameAttr}')" oncontextmenu="event.preventDefault(); removeFromDeck('${safeNameAttr}')"`;
                
                const deckControls = `
                    <div class="deck-controls">
                        <button class="ctrl-btn minus" onclick="event.stopPropagation(); removeFromDeck('${safeNameAttr}')">ï¼</button>
                        <button class="ctrl-btn plus" onclick="event.stopPropagation(); addToDeck('${safeNameAttr}')">ï¼‹</button>
                    </div>
                `;
                div.innerHTML = `<div class="badge">${d.count}</div><img src="images/${d.fileName}" ${imgAction}>${deckControls}`;
                enablePreview(div.querySelector('img'), `images/${d.fileName}`);
                area.appendChild(div);
            });
            document.getElementById('total-count').textContent = totalCards;
            const navBadge = document.getElementById('nav-badge');
            if (navBadge) { navBadge.textContent = totalCards; navBadge.style.display = totalCards > 0 ? 'flex' : 'none'; }
        }

        function removeFromDeck(name) {
            const inDeck = myDeck.find(d => d.name === name);
            if (inDeck) { inDeck.count--; if (inDeck.count <= 0) myDeck = myDeck.filter(d => d.name !== name); }
            renderDeck();
        }

        function switchToMulligan() { 
            document.getElementById('screen-builder').classList.remove('active'); 
            document.getElementById('screen-mulligan').classList.add('active'); 
            document.getElementById('manual-input').value = myDeck.map(d => `${d.name} x${d.count}`).join("\n"); 
            updateMobileNavLabels('mulligan'); showMobilePane('left'); 
        }
        function switchToBuilder() { 
            document.getElementById('screen-mulligan').classList.remove('active'); 
            document.getElementById('screen-builder').classList.add('active'); 
            updateMobileNavLabels('builder'); showMobilePane('left'); 
        }
        
        function applyManualList() {
            const input = document.getElementById('manual-input').value; myDeck = [];
            input.split("\n").forEach(line => {
                let match = line.match(/^(.+?)\s*[xÃ—*]\s*(\d+)$/);
                let name = match ? match[1].trim() : line.trim(); let count = match ? parseInt(match[2]) : 1;
                let master = MASTER_DB.find(m => m.name === name);
                // ãƒˆãƒ¼ã‚¯ãƒ³ã¯æ‰‹å‹•å…¥åŠ›ã§ã‚‚å¼¾ã
                if (master && !master.isToken) myDeck.push({...master, count: Math.min(count, CONFIG.maxCardsInDeck)});
            });
            renderDeck();
        }
        function handleRecipeUpload(e) { const file=e.target.files[0]; const reader=new FileReader(); reader.onload=(ev)=>{ document.getElementById('manual-input').value=ev.target.result; applyManualList(); }; reader.readAsText(file); }
        
        function initSim() {
            simDeck = []; myDeck.forEach(card => { for (let i = 0; i < card.count; i++) simDeck.push({...card}); });
            if (simDeck.length < 1) return alert("ãƒ‡ãƒƒã‚­ãŒç©ºã§ã™");
            for (let i = simDeck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [simDeck[i], simDeck[j]] = [simDeck[j], simDeck[i]]; }
            document.getElementById('play-area').innerHTML = '';
            const hSize = parseInt(document.getElementById('hand-size').value);
            for (let i = 0; i < hSize; i++) drawOne();
            updateSimCount();
            if (isMobile()) showMobilePane('right');
        }
        function drawOne() {
            if (simDeck.length === 0) return; const card = simDeck.pop();
            const img = document.createElement('img'); img.src = `images/${card.fileName}`; img.className = 'play-card';
            enablePreview(img, `images/${card.fileName}`); 
            if (!isMobile()) img.onclick = () => img.remove();
            document.getElementById('play-area').appendChild(img); updateSimCount();
        }
        function updateSimCount() { document.getElementById('sim-deck-count').textContent = simDeck.length; }
        function copyRecipe() { let txt = myDeck.map(d => `${d.name} x${d.count}`).join("\n"); navigator.clipboard.writeText(txt).then(() => alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼")); }
    </script>
</body>
</html>
