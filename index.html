<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>ãƒ‡ãƒƒã‚­ãƒ“ãƒ«ãƒ€ãƒ¼ | ã‚¯ãƒªãƒ•ãƒ­-Crystal Frontier-</title>
    <style>
        /* =========================================
           â˜…é›†ä¸­ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚¨ãƒªã‚¢ (CSSãƒ‡ã‚¶ã‚¤ãƒ³)
           ========================================= */
        :root {
            /* åŸºæœ¬ã‚«ãƒ©ãƒ¼ */
            --bg: #0d1117;          /* å…¨ä½“ã®èƒŒæ™¯è‰² */
            --panel: #161b22;       /* ãƒ‘ãƒãƒ«ã®èƒŒæ™¯è‰² */
            --accent: #f1c40f;      /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ï¼ˆé‡‘ï¼‰ */
            --text: #c9d1d9;        /* é€šå¸¸æ–‡å­—è‰² */
            --border: #30363d;      /* æ ç·šã®è‰² */

            /* çŠ¶æ…‹ã‚«ãƒ©ãƒ¼ */
            --green: #238636;       /* è¿½åŠ ãƒœã‚¿ãƒ³ãƒ»æˆåŠŸè‰² */
            --red: #f85149;         /* å‰Šé™¤ãƒœã‚¿ãƒ³ãƒ»è­¦å‘Šè‰² */
            --blue: #1f6feb;        /* é¸æŠä¸­ãƒ»æƒ…å ±è‰² */
            
            /* ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºè¨­å®š */
            --card-w: 110px;        /* ã‚«ãƒ¼ãƒ‰ã®æ¨ªå¹…(PC) */
            --card-h: 154px;        /* ã‚«ãƒ¼ãƒ‰ã®ç¸¦å¹…(PC) */
            --card-radius: 6px;     /* ã‚«ãƒ¼ãƒ‰ã®è§’ä¸¸ */
            --card-shadow: 0 4px 12px rgba(0,0,0,0.5); /* ã‚«ãƒ¼ãƒ‰ã®å½± */
            
            /* æ¼”å‡ºãƒ»ãã®ä»– */
            --anim-speed: 0.3s;     /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é€Ÿåº¦ */
            --glass-bg: rgba(22, 27, 34, 0.8); /* åŠé€æ˜ãƒ‘ãƒãƒ«ã®èƒŒæ™¯ */
        }

        /* -----------------------------------------
           ä»¥ä¸‹ã€ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå¤‰æ›´ä¸è¦ï¼‰
           ----------------------------------------- */
        body { 
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "BIZ UDPGothic", sans-serif; 
            background: var(--bg); color: var(--text); 
            margin: 0; padding: 0; overflow: hidden; font-size: 13px;
            touch-action: manipulation; width: 100%; height: 100dvh;
        }
        
        .screen { display: none; height: 100dvh; width: 100%; flex-direction: row; }
        .active { display: flex; }
        
        .left-pane { 
            width: 450px; min-width: 280px; max-width: 80vw;
            padding: 10px; display: flex; flex-direction: column; box-sizing: border-box; flex-shrink: 0; 
        }

        .gutter {
            width: 8px; background: #21262d; cursor: col-resize;
            border-left: 1px solid var(--border); border-right: 1px solid var(--border);
            transition: background 0.2s; flex-shrink: 0; z-index: 100;
            display: flex; align-items: center; justify-content: center;
        }
        .gutter:hover, .gutter.dragging { background: var(--accent); }
        .gutter::after { content: "||"; color: #555; font-size: 9px; letter-spacing: -1px; }

        .right-pane { 
            flex-grow: 1; min-width: 0; padding: 10px; 
            display: flex; flex-direction: column; box-sizing: border-box; background: var(--bg); 
        }
        
        .filter-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 8px; 
            background: var(--panel); padding: 10px; border-radius: 8px; border: 1px solid var(--border); 
        }
        .filter-grid label { grid-column: span 2; font-size: 10px; color: var(--accent); margin-top: 4px; font-weight: bold; text-transform: uppercase; }
        
        input, select, textarea { 
            background: #0d1117; color: #fff; border: 1px solid var(--border); 
            padding: 4px 8px; border-radius: 4px; font-size: 12px; height: 30px; box-sizing: border-box; 
        }
        textarea { width: 100%; height: 80px; resize: none; margin-bottom: 10px; padding: 8px; }
        .range-box { display: flex; align-items: center; gap: 4px; }
        .range-box input { width: 100%; }

        .check-group { display: flex; flex-wrap: wrap; gap: 4px; grid-column: span 2; margin-bottom: 4px; }
        .check-label {
            display: inline-block; cursor: pointer; font-size: 11px;
            background: #21262d; border: 1px solid var(--border);
            padding: 4px 10px; border-radius: 4px; color: var(--text); user-select: none; transition: 0.2s;
        }
        .check-label input { display: none; } 
        .check-label:has(input:checked) { background: var(--blue); color: #fff; border-color: var(--blue); }

        #search-results { flex-grow: 1; overflow-y: auto; background: #000; border: 1px solid var(--border); border-radius: 4px; }
        #deck-list { 
            flex-grow: 1; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; 
            display: grid; grid-template-columns: repeat(auto-fill, var(--card-w)); 
            gap: 12px; align-content: start; 
        }
        #play-area { flex-grow: 1; overflow-y: auto; background: radial-gradient(circle, #0a2012 0%, #000 100%); border-radius: 8px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; padding: 20px; }

        /* ã‚«ãƒ¼ãƒ‰è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .card-row { display: flex; padding: 8px; border-bottom: 1px solid var(--border); gap: 10px; background: #161b22; align-items: flex-start; transition: 0.1s; }
        .card-row:hover { background: #1c2128; }
        
        .img-box { 
            width: 50px; height: 70px; background: #222; border: 1px solid #444; border-radius: 4px;
            flex-shrink: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden;
        }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .card-name { font-weight: bold; color: #fff; font-size: 14px; white-space: nowrap; overflow-x: auto; scrollbar-width: none; }
        .card-name::-webkit-scrollbar { display: none; }
        
        .card-sub { font-size: 11px; color: #8b949e; display: flex; align-items: center; width: 100%; overflow: hidden; }
        .stat-emphasis { font-family: "Impact", sans-serif; font-size: 16px; color: #fff; letter-spacing: 0.5px; flex-shrink: 0; }
        .info-scroll-area { flex-grow: 1; overflow-x: auto; white-space: nowrap; scrollbar-width: none; margin-left: 6px; }

        .card-effect {
            font-size: 11px; color: #d1d5da; line-height: 1.5;
            background: rgba(0,0,0,0.4); padding: 6px; border-radius: 4px;
            max-height: 54px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #30363d;
        }

        .inline-icon { height: 1.2em; width: auto; vertical-align: middle; margin: 0 1px; }
        
        /* ãƒœã‚¿ãƒ³é¡ */
        .btn-add { width: 44px; height: 100%; align-self: stretch; font-size: 20px; flex-shrink: 0; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: #fff; font-size: 12px; transition: filter 0.2s; }
        .btn:active { filter: brightness(0.8); }
        .btn-green { background: var(--green); } .btn-blue { background: var(--blue); } .btn-accent { background: var(--accent); color: #000; } .btn-red { background: var(--red); }

        /* ãƒ‡ãƒƒã‚­å†…ã‚«ãƒ¼ãƒ‰ */
        .deck-item { position: relative; width: var(--card-w); height: var(--card-h); box-shadow: var(--card-shadow); }
        .deck-item img { width: 100%; height: 100%; border: 1px solid #fff; border-radius: var(--card-radius); object-fit: cover; }
        .badge { 
            position: absolute; top: -8px; right: -8px; background: var(--red); color: #fff; 
            width: 24px; height: 24px; line-height: 24px; border-radius: 50%; 
            font-weight: bold; text-align: center; border: 2px solid #fff; z-index: 10; font-size: 12px; 
        }
        
        .deck-controls {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 32px; z-index: 20;
            border-radius: 0 0 var(--card-radius) var(--card-radius); overflow: hidden; display: flex;
        }
        .ctrl-btn { width: 50%; height: 100%; border: none; color: #fff; font-weight: bold; font-size: 18px; cursor: pointer; }
        .ctrl-btn.minus { background: rgba(200, 50, 50, 0.9); }
        .ctrl-btn.plus { background: rgba(50, 200, 50, 0.9); }

        .play-card { width: 120px; height: 168px; border: 2px solid #fff; border-radius: 8px; background: #000; animation: drawAnim var(--anim-speed) ease-out; cursor: help; }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        #hover-preview { 
            position: fixed; z-index: 9999; pointer-events: none; display: none; 
            background: #000; border: 3px solid var(--accent); border-radius: 12px; 
            box-shadow: 0 0 40px rgba(0,0,0,0.8); width: 320px; height: 448px; overflow: hidden; 
        }
        #hover-preview img { width: 100%; height: 100%; object-fit: contain; }
        
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        @keyframes drawAnim { from { transform: translateY(30px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 768px) {
            :root { --card-w: 80px; --card-h: 112px; }
            .left-pane, .right-pane { width: 100% !important; max-width: 100% !important; display: none; }
            .active-pane { display: flex; }
            .gutter { display: none; }
            #mobile-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: var(--panel); border-top: 1px solid var(--border); z-index: 3000; padding-bottom: env(safe-area-inset-bottom); }
            .nav-btn { flex: 1; border: none; background: none; color: #8b949e; font-weight: bold; font-size: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
            .nav-btn.active { color: var(--accent); background: rgba(255,255,255,0.05); }
        }
    </style>
</head>
<body>
    <div id="hover-preview" onclick="closePreviewMobile()">
        <img id="preview-img" src="">
        <div id="preview-close-btn" style="display:none; position:absolute; top:10px; right:10px; width:40px; height:40px; background:rgba(0,0,0,0.5); color:#fff; border-radius:50%; align-items:center; justify-content:center; font-size:24px;">Ã—</div>
    </div>
    
    <div id="file-overlay" class="overlay" style="display: none;">
        <h2 style="color:var(--accent);">Crystal Frontier System</h2>
        <p>ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ(CSV)ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <input type="file" id="csv-file" accept=".csv" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-green" onclick="loadFile('UTF-8')">UTF-8ã§èª­ã¿è¾¼ã¿</button>
            <button class="btn btn-blue" onclick="loadFile('Shift-JIS')">Shift-JISã§èª­ã¿è¾¼ã¿</button>
        </div>
    </div>

    <div id="screen-builder" class="screen active">
        <div class="left-pane" id="pane-l-build">
            <div class="filter-grid" style="margin-bottom: 5px; grid-template-columns: 1fr;">
                <input type="text" id="q-text" placeholder="ã‚«ãƒ¼ãƒ‰åã€èª­ã¿ã€åŠ¹æœã§æ¤œç´¢..." oninput="filterCards()">
            </div>

            <button id="filter-toggle-btn" style="width:100%; padding:10px; margin-bottom:5px; background:#21262d; border:1px solid #30363d; color:#8b949e; border-radius:4px; cursor:pointer;" onclick="toggleFilters()">â–¼ è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¡¨ç¤º</button>

            <div class="filter-grid" id="advanced-filters" style="display:none;">
                <label>åˆ†é¡</label>
                <div class="check-group" id="grp-cat">
                    <label class="check-label"><input type="checkbox" value="ãƒ¦ãƒ‹ãƒƒãƒˆ" onchange="filterCards()"> ãƒ¦ãƒ‹ãƒƒãƒˆ</label>
                    <label class="check-label"><input type="checkbox" value="ãƒã‚¸ãƒƒã‚¯" onchange="filterCards()"> ãƒã‚¸ãƒƒã‚¯</label>
                    <label class="check-label"><input type="checkbox" value="ãƒ•ãƒ©ãƒƒã‚·ãƒ¥" onchange="filterCards()"> ãƒ•ãƒ©ãƒƒã‚·ãƒ¥</label>
                    <label class="check-label"><input type="checkbox" value="ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ" onchange="filterCards()"> ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</label>
                    <label class="check-label"><input type="checkbox" value="ã‚ªãƒ«ã‚¬ãƒãƒ³" onchange="filterCards()"> ã‚ªãƒ«ã‚¬ãƒãƒ³</label>
                </div>

                <label>å±æ€§/è‰²</label>
                <div class="check-group" id="grp-col">
                    <label class="check-label"><input type="checkbox" value="èµ¤" onchange="filterCards()"> èµ¤</label>
                    <label class="check-label"><input type="checkbox" value="ç·‘" onchange="filterCards()"> ç·‘</label>
                    <label class="check-label"><input type="checkbox" value="é’" onchange="filterCards()"> é’</label>
                    <label class="check-label"><input type="checkbox" value="ç™½" onchange="filterCards()"> ç™½</label>
                    <label class="check-label"><input type="checkbox" value="é»’" onchange="filterCards()"> é»’</label>
                    <label class="check-label"><input type="checkbox" value="ç„¡" onchange="filterCards()"> ç„¡</label>
                </div>

                <label>ã‚³ã‚¹ãƒˆç¯„å›²</label>
                <div class="range-box">
                    <input type="number" id="q-cost-min" placeholder="0" oninput="filterCards()">
                    <span>~</span>
                    <input type="number" id="q-cost-max" placeholder="MAX" oninput="filterCards()">
                </div>
                
                <label>ä¸¦ã³æ›¿ãˆ</label>
                <div style="grid-column: span 2; display: flex; gap: 5px;">
                    <select id="q-sort-key" onchange="filterCards()" style="flex: 2;">
                        <option value="id">ç™»éŒ²é †</option>
                        <option value="name">äº”åéŸ³é †</option>
                        <option value="costTotal">ã‚³ã‚¹ãƒˆé †</option>
                        <option value="atk">ATKé †</option>
                        <option value="hp">HPé †</option>
                    </select>
                    <select id="q-sort-dir" onchange="filterCards()" style="flex: 1;">
                        <option value="1">æ˜‡é †</option>
                        <option value="-1">é™é †</option>
                    </select>
                </div>
            </div>
            
            <div id="search-results"></div>
        </div>

        <div class="gutter" id="gutter-build"></div>
        
        <div class="right-pane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                <h3 style="margin:0;">Deck: <span id="total-count" style="color:var(--accent);">0</span></h3>
                <button class="btn btn-accent" onclick="switchToMulligan()">ä¸€äººå›ã—ãƒ†ã‚¹ãƒˆ â”</button>
            </div>
            <div id="deck-list"></div>
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button class="btn btn-blue" style="flex:1;" onclick="copyRecipe()">ğŸ“‹ ãƒ¬ã‚·ãƒ”ã‚’ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btn-red" onclick="if(confirm('ãƒ‡ãƒƒã‚­ã‚’ç©ºã«ã—ã¾ã™ã‹ï¼Ÿ')){myDeck=[];renderDeck();}">æ¶ˆå»</button>
            </div>
        </div>
    </div>

    <div id="screen-mulligan" class="screen">
        <div class="left-pane" id="pane-l-mulligan">
            <button class="btn btn-blue" onclick="switchToBuilder()" style="margin-bottom:15px;">â† æ§‹ç¯‰ç”»é¢ã¸æˆ»ã‚‹</button>
            <label style="font-size:10px; color:var(--accent); font-weight:bold;">DECK LIST (ç·¨é›†å¯)</label>
            <textarea id="manual-input" placeholder="ã‚«ãƒ¼ãƒ‰å xæšæ•°..."></textarea>
            <div style="display: flex; gap: 5px; margin-bottom:15px;">
                <button class="btn btn-green" style="flex:1" onclick="applyManualList()">ãƒªã‚¹ãƒˆã‚’é©ç”¨</button>
            </div>
            <div class="filter-grid">
                <label>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼è¨­å®š</label>
                åˆæ‰‹æšæ•°: <input type="number" id="hand-size-input" value="7">
                <button class="btn btn-accent" style="grid-column:span 2; margin-top:10px;" onclick="initSim()">å±±æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦é–‹å§‹</button>
            </div>
        </div>
        <div class="gutter" id="gutter-mulligan"></div>
        <div class="right-pane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                <h3 style="margin:0;">Hand / Field (å±±æœ­: <span id="sim-deck-count" style="color:var(--accent);">0</span>)</h3>
                <button class="btn btn-green" onclick="drawOne()">1æšå¼•ã</button>
            </div>
            <div id="play-area"></div>
        </div>
    </div>

    <div id="mobile-nav">
        <button class="nav-btn active" id="btn-search" onclick="showMobilePane('left')">ğŸ” æ¤œç´¢ãƒ»æ¡ä»¶</button>
        <button class="nav-btn" id="btn-deck" onclick="showMobilePane('right')">ğŸƒ ãƒ‡ãƒƒã‚­ãƒ»æ“ä½œ</button>
    </div>

    <script>
        /* =========================================
           â˜…é›†ä¸­ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚¨ãƒªã‚¢ (JSã‚·ã‚¹ãƒ†ãƒ è¨­å®š)
           ========================================= */
        const CONFIG = {
            // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«è¨­å®š
            maxCardsPerName: 4,      /* åŒåã‚«ãƒ¼ãƒ‰ã®æœ€å¤§æšæ•° */
            defaultHandSize: 7,      /* ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®åˆæœŸæ‰‹æœ­ */
            minDeckSize: 40,         /* (å‚è€ƒ) æ¨å¥¨ãƒ‡ãƒƒã‚­æšæ•° */

            // ãƒ‘ã‚¹ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š
            csvPath: 'card_list.csv',      /* èª­ã¿è¾¼ã‚€CSVã®ãƒ•ã‚¡ã‚¤ãƒ«å */
            imageDir: 'images/',           /* ã‚«ãƒ¼ãƒ‰ç”»åƒã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ */
            iconDir: 'images/icons/',      /* åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆå†…ã®ã‚¢ã‚¤ã‚³ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ */
            noImage: 'https://via.placeholder.com/110x154?text=No+Image', /* ç”»åƒãŒãªã„æ™‚ã®ä»£æ›¿ */

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®š
            previewDelay: 300,       /* PCã§ãƒ›ãƒãƒ¼ã—ã¦ã‹ã‚‰è¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§ã®æ™‚é–“(ms) */
            
            // æ•°å€¤ã®æœ€å¤§å€¤è¨­å®šï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ï¼‰
            limit: {
                cost: 99,
                atk: 99999,
                hp: 99999
            }
        };

        /* -----------------------------------------
           ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•°
           ----------------------------------------- */
        let MASTER_DB = [], myDeck = [], simDeck = [], hoverTimer = null;
        const isMobile = () => window.innerWidth <= 768;

        /* -----------------------------------------
           åˆæœŸåŒ–
           ----------------------------------------- */
        window.addEventListener('DOMContentLoaded', () => {
            // ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–
            setupResizer('pane-l-build', 'gutter-build');
            setupResizer('pane-l-mulligan', 'gutter-mulligan');
            
            // CSVã®è‡ªå‹•èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
            fetch(CONFIG.csvPath)
                .then(res => { if(!res.ok) throw new Error(); return res.text(); })
                .then(text => parseCSV(text))
                .catch(() => {
                    // å¤±æ•—ã—ãŸå ´åˆã¯æ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ã‚’è¡¨ç¤º
                    document.getElementById('file-overlay').style.display = 'flex';
                });
            
            // åˆæœŸè¨­å®šã®åæ˜ 
            document.getElementById('hand-size-input').value = CONFIG.defaultHandSize;
        });

        /* -----------------------------------------
           CSVè§£æãƒ­ã‚¸ãƒƒã‚¯
           ----------------------------------------- */
        function parseCSV(txt) {
            const lines = txt.split(/\r?\n/);
            MASTER_DB = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim(); if(!line) continue;
                // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼ˆã‚¯ã‚©ãƒ¼ãƒˆè€ƒæ…®ï¼‰
                const cells = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (cells.length < 10) continue;

                const clean = (s) => (s || "").replace(/^"|"$/g, '').replace(/""/g, '"').trim();
                
                // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã®å‡¦ç†
                let fName = clean(cells[16]);
                if (fName && !fName.includes(".")) fName += ".png";

                // åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆã®çµåˆ
                const effects = [cells[11], cells[12], cells[13], cells[14]]
                    .map(clean)
                    .filter(t => t && t !== "-" && t !== "â€")
                    .join("\n");

                const name = clean(cells[0]);
                const reading = clean(cells[17]);

                MASTER_DB.push({
                    id: i,
                    name: name,
                    reading: reading,
                    color: clean(cells[1]),
                    rarity: clean(cells[2]),
                    category: clean(cells[3]),
                    type: clean(cells[4]),
                    costTotal: parseInt(clean(cells[6])) || 0,
                    atk: parseInt(clean(cells[8])) || 0,
                    hp: parseInt(clean(cells[9])) || 0,
                    effect: effects,
                    fileName: fName || "default.png",
                    // æ¤œç´¢ç”¨æ–‡å­—åˆ—
                    searchText: (name + reading + effects + clean(cells[4])).toLowerCase()
                });
            }
            filterCards();
            document.getElementById('file-overlay').style.display = 'none';
        }

        /* -----------------------------------------
           æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
           ----------------------------------------- */
        function filterCards() {
            const getChecked = (id) => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(e => e.value);
            const val = (id, def) => { const v = document.getElementById(id).value; return v === "" ? def : parseInt(v); };

            const q = {
                text: document.getElementById('q-text').value.toLowerCase(),
                cats: getChecked('grp-cat'),
                cols: getChecked('grp-col'),
                cMin: val('q-cost-min', 0),
                cMax: val('q-cost-max', CONFIG.limit.cost)
            };

            let filtered = MASTER_DB.filter(c => {
                if (q.text && !c.searchText.includes(q.text)) return false;
                if (q.cats.length && !q.cats.some(cat => c.category.includes(cat))) return false;
                if (q.cols.length && !q.cols.some(col => c.color.includes(col))) return false;
                if (c.costTotal < q.cMin || c.costTotal > q.cMax) return false;
                return true;
            });

            // ã‚½ãƒ¼ãƒˆ
            const sk = document.getElementById('q-sort-key').value;
            const sd = parseInt(document.getElementById('q-sort-dir').value);
            filtered.sort((a, b) => {
                let vA = a[sk], vB = b[sk];
                if (sk === 'name') { vA = a.reading || a.name; vB = b.reading || b.name; return vA.localeCompare(vB, 'ja') * sd; }
                return (vA - vB) * sd;
            });

            renderResults(filtered);
        }

        /* -----------------------------------------
           æç”»ç³»
           ----------------------------------------- */
        function renderResults(list) {
            const area = document.getElementById('search-results');
            area.innerHTML = '';
            list.forEach(c => {
                const row = document.createElement('div');
                row.className = 'card-row';
                
                // åŠ¹æœå†…ã®ã‚¢ã‚¤ã‚³ãƒ³ç½®æ›
                const effectHtml = c.effect.replace(/\(([^)]{1,15})\)/g, (m, icon) => {
                    return `<img src="${CONFIG.iconDir}${icon.trim()}.png" class="inline-icon" onerror="this.style.display='none';this.insertAdjacentText('afterend','${m}')">`;
                });

                row.innerHTML = `
                    <div class="img-box" onclick="addToDeck('${c.name.replace(/'/g, "\\'")}')">
                        <img src="${CONFIG.imageDir}${c.fileName}" onerror="this.src='${CONFIG.noImage}'">
                    </div>
                    <div class="card-info">
                        <div class="card-name">${c.name}</div>
                        <div class="card-sub">
                            ${c.atk || c.hp ? `<span class="stat-emphasis">${c.atk}/${c.hp}</span>` : ''}
                            <span class="info-scroll-area">| ${c.costTotal}CP | ${c.category} | ${c.type}</span>
                        </div>
                        ${c.effect ? `<div class="card-effect">${effectHtml}</div>` : ''}
                    </div>
                    <button class="btn btn-green btn-add" onclick="addToDeck('${c.name.replace(/'/g, "\\'")}')">+</button>
                `;
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸
                const img = row.querySelector('img');
                setupPreview(img, `${CONFIG.imageDir}${c.fileName}`);
                
                area.appendChild(row);
            });
        }

        function renderDeck() {
            const area = document.getElementById('deck-list');
            area.innerHTML = '';
            myDeck.forEach(d => {
                const item = document.createElement('div');
                item.className = 'deck-item';
                item.innerHTML = `
                    <div class="badge">${d.count}</div>
                    <img src="${CONFIG.imageDir}${d.fileName}" onerror="this.src='${CONFIG.noImage}'">
                    <div class="deck-controls">
                        <button class="ctrl-btn minus" onclick="removeFromDeck('${d.name.replace(/'/g, "\\'")}')">ï¼</button>
                        <button class="ctrl-btn plus" onclick="addToDeck('${d.name.replace(/'/g, "\\'")}')">ï¼‹</button>
                    </div>
                `;
                setupPreview(item.querySelector('img'), `${CONFIG.imageDir}${d.fileName}`);
                area.appendChild(item);
            });
            document.getElementById('total-count').textContent = myDeck.reduce((sum, d) => sum + d.count, 0);
        }

        /* -----------------------------------------
           ãƒ‡ãƒƒã‚­æ“ä½œ
           ----------------------------------------- */
        function addToDeck(name) {
            const master = MASTER_DB.find(m => m.name === name);
            if (!master) return;
            const inDeck = myDeck.find(d => d.name === name);
            
            if (inDeck) {
                if (inDeck.count >= CONFIG.maxCardsPerName) return;
                inDeck.count++;
            } else {
                myDeck.push({...master, count: 1});
            }
            renderDeck();
        }

        function removeFromDeck(name) {
            const inDeck = myDeck.find(d => d.name === name);
            if (inDeck) {
                inDeck.count--;
                if (inDeck.count <= 0) myDeck = myDeck.filter(d => d.name !== name);
            }
            renderDeck();
        }

        /* -----------------------------------------
           ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
           ----------------------------------------- */
        function setupPreview(el, src) {
            if (isMobile()) {
                el.onclick = (e) => {
                    e.stopPropagation();
                    const p = document.getElementById('hover-preview');
                    document.getElementById('preview-img').src = src;
                    p.style.display = 'flex';
                    p.style.opacity = '1';
                };
            } else {
                el.onmouseenter = (e) => {
                    hoverTimer = setTimeout(() => {
                        const p = document.getElementById('hover-preview');
                        document.getElementById('preview-img').src = src;
                        p.style.display = 'block';
                        updatePreviewPos(e);
                    }, CONFIG.previewDelay);
                };
                el.onmousemove = updatePreviewPos;
                el.onmouseleave = () => {
                    clearTimeout(hoverTimer);
                    document.getElementById('hover-preview').style.display = 'none';
                };
            }
        }

        function updatePreviewPos(e) {
            const p = document.getElementById('hover-preview');
            let x = e.clientX + 20, y = e.clientY + 20;
            if (x + 320 > window.innerWidth) x = e.clientX - 340;
            if (y + 448 > window.innerHeight) y = window.innerHeight - 460;
            p.style.left = x + 'px'; p.style.top = Math.max(10, y) + 'px';
        }

        function closePreviewMobile() {
            document.getElementById('hover-preview').style.display = 'none';
        }

        /* -----------------------------------------
           ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»ç”»é¢é·ç§»
           ----------------------------------------- */
        function setupResizer(paneId, gutterId) {
            const pane = document.getElementById(paneId);
            const gutter = document.getElementById(gutterId);
            let dragging = false;
            gutter.addEventListener('mousedown', () => dragging = true);
            document.addEventListener('mousemove', (e) => {
                if (!dragging) return;
                pane.style.width = Math.max(250, Math.min(e.clientX, window.innerWidth * 0.8)) + 'px';
            });
            document.addEventListener('mouseup', () => dragging = false);
        }

        function toggleFilters() {
            const f = document.getElementById('advanced-filters');
            const btn = document.getElementById('filter-toggle-btn');
            const isHidden = f.style.display === 'none';
            f.style.display = isHidden ? 'grid' : 'none';
            btn.textContent = isHidden ? 'â–² ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é–‰ã˜ã‚‹' : 'â–¼ è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¡¨ç¤º';
        }

        function showMobilePane(side) {
            const left = document.querySelector('.left-pane.active-pane') || document.querySelector('.left-pane');
            const right = document.querySelector('.right-pane.active-pane') || document.querySelector('.right-pane');
            if (side === 'left') {
                left.classList.add('active-pane'); right.classList.remove('active-pane');
                document.getElementById('btn-search').classList.add('active');
                document.getElementById('btn-deck').classList.remove('active');
            } else {
                left.classList.remove('active-pane'); right.classList.add('active-pane');
                document.getElementById('btn-search').classList.remove('active');
                document.getElementById('btn-deck').classList.add('active');
            }
        }

        function switchToMulligan() {
            document.getElementById('screen-builder').classList.remove('active');
            document.getElementById('screen-mulligan').classList.add('active');
            document.getElementById('manual-input').value = myDeck.map(d => `${d.name} x${d.count}`).join("\n");
            if(isMobile()) showMobilePane('left');
        }

        function switchToBuilder() {
            document.getElementById('screen-mulligan').classList.remove('active');
            document.getElementById('screen-builder').classList.add('active');
            if(isMobile()) showMobilePane('left');
        }

        function copyRecipe() {
            const txt = myDeck.map(d => `${d.name} x${d.count}`).join("\n");
            navigator.clipboard.writeText(txt).then(() => alert("ãƒ¬ã‚·ãƒ”ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
        }

        /* -----------------------------------------
           ä¸€äººå›ã—ãƒ­ã‚¸ãƒƒã‚¯
           ----------------------------------------- */
        function applyManualList() {
            const lines = document.getElementById('manual-input').value.split('\n');
            myDeck = [];
            lines.forEach(line => {
                const match = line.match(/^(.+?)\s*[xÃ—*]\s*(\d+)$/);
                const name = (match ? match[1] : line).trim();
                const count = match ? parseInt(match[2]) : 1;
                const master = MASTER_DB.find(m => m.name === name);
                if (master) myDeck.push({...master, count: Math.min(count, CONFIG.maxCardsPerName)});
            });
            renderDeck();
            alert("ãƒªã‚¹ãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸ");
        }

        function initSim() {
            simDeck = [];
            myDeck.forEach(d => { for(let i=0; i<d.count; i++) simDeck.push({...d}); });
            if (simDeck.length === 0) return alert("ãƒ‡ãƒƒã‚­ãŒç©ºã§ã™");
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            for (let i = simDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [simDeck[i], simDeck[j]] = [simDeck[j], simDeck[i]];
            }
            
            document.getElementById('play-area').innerHTML = '';
            const size = parseInt(document.getElementById('hand-size-input').value) || CONFIG.defaultHandSize;
            for (let i = 0; i < size; i++) drawOne();
            updateSimCount();
            if (isMobile()) showMobilePane('right');
        }

        function drawOne() {
            if (simDeck.length === 0) return;
            const card = simDeck.pop();
            const img = document.createElement('img');
            img.src = `${CONFIG.imageDir}${card.fileName}`;
            img.className = 'play-card';
            img.onclick = () => img.remove();
            setupPreview(img, img.src);
            document.getElementById('play-area').appendChild(img);
            updateSimCount();
        }

        function updateSimCount() {
            document.getElementById('sim-deck-count').textContent = simDeck.length;
        }

        function loadFile(enc) {
            const file = document.getElementById('csv-file').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => parseCSV(e.target.result);
            reader.readAsText(file, enc);
        }
    </script>
</body>
</html>
